name: JARVIS Integrated Evolution
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  evolution_cycle:
    name: "üß¨ Ciclo de Evolu√ß√£o"
    # Prote√ß√£o contra execu√ß√£o em PRs abertas
    if: github.event_name != 'pull_request' && !contains(github.event.head_commit.message, '[Auto-Evolution] DNA Mutated')
    runs-on: ubuntu-latest
    outputs:
      action: ${{ steps.flow.outputs.action }}
      pr_number: ${{ steps.create_pr.outputs.pr_number }}
      branch: ${{ steps.create_pr.outputs.branch }}
      mission_desc: ${{ steps.flow.outputs.mission_desc }}
    steps:
      - name: üõ∞Ô∏è Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.JARVIS_PAT || secrets.GITHUB_TOKEN }}

      - name: üì¶ Setup UV
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: üß† Orquestrador e Identifica√ß√£o de Miss√£o
        id: flow
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          GH_TOKEN: ${{ secrets.JARVIS_PAT || secrets.GITHUB_TOKEN }}
          PYTHONPATH: ${{ github.workspace }}
        run: |
          uv venv --python 3.11
          source .venv/bin/activate
          uv pip install sqlmodel requests pydantic groq python-dotenv
          
          python - << 'PYCODE'
          import os, sys, re
          from app.application.services.auto_evolutionV2 import AutoEvolutionServiceV2
          
          try:
              auto = AutoEvolutionServiceV2()
              github_output = os.environ.get('GITHUB_OUTPUT')
              
              # 1. Analisa a mensagem do √∫ltimo commit (DNA do Merge)
              last_msg = os.popen("git log -1 --pretty=%B").read()
              print(f"--- ANALISANDO DNA ---\nMsg: {last_msg.strip()}")
              
              # L√≥gica corrigida para capturar o padr√£o do log: 'auto-evolution/mission-XXX'
              is_auto_evolution = bool(re.search(r'auto-evolution|mission-\d+', last_msg, re.IGNORECASE))
              is_sync = "Inventory Synchronized" in last_msg
              
              # 2. SE FOR MERGE DE AUTO-EVOLU√á√ÉO: Sincroniza e Encerra (FIM DO LOOP)
              if is_auto_evolution and not is_sync:
                  print("üéØ DNA de Evolu√ß√£o detectado. Sincronizando Homeostase...")
                  
                  # Busca o CAP-ID na mensagem do commit para finalizar no banco
                  match = re.search(r'CAP-\d+', last_msg)
                  if match:
                      cap_id = match.group()
                      if auto.mark_mission_as_completed(cap_id):
                          print(f"‚úÖ Sincroniza√ß√£o conclu√≠da: {cap_id} integrada.")
                  
                  # For√ßa o modo IDLE para n√£o iniciar nova miss√£o no mesmo ciclo
                  with open(github_output, 'a') as f:
                      f.write("action=idle\n")
                  sys.exit(0
