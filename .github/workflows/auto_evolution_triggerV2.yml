name: JARVIS Integrated Evolution

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  evolution_cycle:
    name: "üß¨ Ciclo de Evolu√ß√£o"
    # Evita rodar em PRs ou se o commit j√° for de uma evolu√ß√£o conclu√≠da
    if: github.event_name != 'pull_request' && !contains(github.event.head_commit.message, '[Auto-Evolution] DNA Mutated')
    runs-on: ubuntu-latest
    outputs:
      action: ${{ steps.flow.outputs.action }}
      pr_number: ${{ steps.create_pr.outputs.pr_number }}
      branch: ${{ steps.create_pr.outputs.branch }}
      mission_desc: ${{ steps.flow.outputs.mission_desc }}
    steps:
      - name: üõ∞Ô∏è Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # Uso obrigat√≥rio do GIT_PAT para que a PR dispare os workflows de Homeostase
          token: ${{ secrets.GIT_PAT }}

      - name: üì¶ Setup UV
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          python-version: '3.11'

      - name: üß† Orquestrador e Identifica√ß√£o de Miss√£o
        id: flow
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          GH_TOKEN: ${{ secrets.GIT_PAT }}
          PYTHONPATH: ${{ github.workspace }}
        run: |
          uv venv --clear --python 3.11
          source .venv/bin/activate
          uv pip install sqlmodel requests pydantic groq python-dotenv
          
          python - << 'PYCODE'
          import os, sys, re
          from app.application.services.auto_evolutionV2 import AutoEvolutionServiceV2
          
          try:
              auto = AutoEvolutionServiceV2()
              github_output = os.environ.get('GITHUB_OUTPUT')
              
              last_msg = os.popen("git log -1 --pretty=%B").read()
              print(f"--- ANALISANDO DNA ---\nMsg: {last_msg.strip()}")
              
              is_auto_evolution = bool(re.search(r'auto-evolution|mission-\d+', last_msg, re.IGNORECASE))
              is_sync = "Inventory Synchronized" in last_msg
              
              # Sincroniza√ß√£o de status sem cristaliza√ß√£o
              if is_auto_evolution and not is_sync:
                  print("üéØ DNA de Evolu√ß√£o detectado. Atualizando status da miss√£o...")
                  match = re.search(r'CAP-\d+', last_msg)
                  if match:
                      cap_id = match.group()
                      if auto.mark_mission_as_completed(cap_id):
                          print(f"‚úÖ Miss√£o {cap_id} marcada como integrada no sistema.")
                  
                  with open(github_output, 'a') as f:
                      f.write("action=idle\n")
                  sys.exit(0)

              print("üü¢ Analisando apostila de aprendizado para pr√≥xima muta√ß√£o...")
              next_m = auto.find_next_mission()
              
              if next_m:
                  context = auto.get_roadmap_context(next_m)
                  with open('mission_context.txt', 'w', encoding='utf-8') as mc:
                      mc.write(context)
                  
                  with open(github_output, 'a', encoding='utf-8') as f:
                      f.write(f"action=evolve\n")
                      f.write(f"mission_desc={next_m['id']}: {next_m['title']}\n")
                  print(f"üöÄ Miss√£o identificada: {next_m['id']}")
              else:
                  with open(github_output, 'a') as f:
                      f.write("action=idle\n")
                  print("üò¥ Nenhuma miss√£o pendente.")
                  
          except Exception as e:
              print(f"‚ùå Falha no Orquestrador: {e}")
              sys.exit(1)
          PYCODE

      - name: ü§ñ Muta√ß√£o e Abertura de PR
        id: create_pr
        if: steps.flow.outputs.action == 'evolve'
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          GH_TOKEN: ${{ secrets.GIT_PAT }}
          PYTHONPATH: ${{ github.workspace }}
        run: |
          git config --global user.name "Jarvis-Bot"
          git config --global user.email "jarvis@bot.com"
          
          source .venv/bin/activate
          
          # Cria√ß√£o da Branch de Muta√ß√£o
          BRANCH_NAME="auto-evolution/mission-$(date +%s)"
          git checkout -b "$BRANCH_NAME"
          
          # Execu√ß√£o do Mutator para gerar o novo c√≥digo
          if ! python scripts/evolution_mutator.py \
            --strategy "minimal_change" \
            --intent "auto-evolution-mission" \
            --impact "functional-improvement" \
            --roadmap-context "$(cat mission_context.txt)"; then
              echo "‚ùå Falha na gera√ß√£o da muta√ß√£o."
              exit 1
          fi

          # Persist√™ncia da Muta√ß√£o e Abertura de PR
          git add -A
          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "[Auto-Evolution] DNA Mutated: ${{ steps.flow.outputs.mission_desc }}"
            
            # Garantia de bypass 403 usando o GIT_PAT na URL
            git remote set-url origin https://x-access-token:${{ secrets.GIT_PAT }}@github.com/${{ github.repository }}.git
            git push origin "$BRANCH_NAME"
            
            echo "üì¢ Solicitando integra√ß√£o via Pull Request..."
            PR_URL=$(gh pr create \
                         --title "üß¨ Evolu√ß√£o: ${{ steps.flow.outputs.mission_desc }}" \
                         --body "### üß† Ciclo de Auto-Evolu√ß√£o \nMiss√£o: ${{ steps.flow.outputs.mission_desc }} \n\n Status: C√≥digo mutado com sucesso. Homeostase deve validar a integridade." \
                         --base main --head "$BRANCH_NAME")
            
            echo "pr_number=$(echo $PR_URL | awk -F'/' '{print $6}')" >> $GITHUB_OUTPUT
            echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è Nenhuma altera√ß√£o gerada pela muta√ß√£o."
            echo "action=idle" >> $GITHUB_OUTPUT
          fi
