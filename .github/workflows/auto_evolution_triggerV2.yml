name: Auto Evolution Trigger

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  evolution_cycle:
    name: "ðŸ§¬ Ciclo Unificado JARVIS"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ðŸ“¦ Instalar DependÃªncias
        run: pip install sqlmodel pydantic requests

      - name: ðŸ§  Orquestrador de Fluxo
        id: flow
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          export PYTHONPATH="${PYTHONPATH:+$PYTHONPATH:}$(pwd)"
          python - << 'PYCODE'
          import os, sys, re
          try:
              from app.application.services.auto_evolutionV2 import AutoEvolutionServiceV2
              auto = AutoEvolutionServiceV2()
              
              last_msg = os.popen("git log -1 --pretty=%B").read()
              
              print(f"--- ANALISANDO DNA DO COMMIT ---")
              print(f"Mensagem: {last_msg.strip()}")

              # DETECÃ‡ÃƒO POR NOME DE BRANCH NO MERGE (O rastro que vocÃª apontou)
              is_auto_evolution = "auto-evolution/mission" in last_msg
              is_sync_commit = "Inventory Synchronized" in last_msg

              if is_sync_commit:
                  print("ðŸ›¡ï¸ Trava Anti-Loop: InventÃ¡rio sincronizado. Encerrando.")
                  with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                      f.write("action=idle\n")
                  sys.exit
