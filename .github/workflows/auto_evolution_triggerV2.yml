name: JARVIS Integrated Evolution
on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  evolution_and_healing:
    name: "ðŸ§¬ Ciclo de EvoluÃ§Ã£o e Homeostase"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Setup UV e Python
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          python-version: '3.13'

      - name: ðŸ§  Orquestrador de MissÃ£o
        id: flow
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Instala dependÃªncias bÃ¡sicas para o orquestrador
          uv pip install sqlmodel pydantic requests
          export PYTHONPATH="${PYTHONPATH:+$PYTHONPATH:}$(pwd)"
          python - << 'PYCODE'
          import os, sys
          from app.application.services.auto_evolutionV2 import AutoEvolutionServiceV2
          try:
              auto = AutoEvolutionServiceV2()
              last_msg = os.popen("git log -1 --pretty=%B").read()
              if "[Auto-Evolution]" in last_msg:
                  out = "action=idle\n"
              else:
                  next_m = auto.find_next_mission()
                  if next_m:
                      with open('mission_context.txt', 'w', encoding='utf-8') as f:
                          f.write(auto.get_roadmap_context(next_m))
                      out = f"action=evolve\nmission_desc={next_m['id']}: {next_m['title']}\n"
                  else:
                      out = "action=idle\n"
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f: f.write(out)
          except Exception as e:
              print(f"âŒ Erro: {e}"); sys.exit(1)
          PYCODE

      - name: ðŸ¤– MutaÃ§Ã£o e Auto-Cura
        if: steps.flow.outputs.action == 'evolve'
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_BODY: ${{ steps.flow.outputs.mission_desc }}
        run: |
          git config --global user.name "Jarvis-AutoEvolution"
          git config --global user.email "jarvis@bot.com"
          
          # 1. Preparar Ambiente Completo (DNA Base + Teste)
          # Adicionadas as libs que causaram erro no log: fastapi, jose, passlib, bcrypt
          uv pip install pytest pytest-json-report pytest-cov pytest-asyncio \
                         pydantic pydantic-settings cryptography httpx \
                         sqlmodel groq python-dotenv \
                         fastapi python-jose[cryptography] passlib[bcrypt] bcrypt \
                         -e .
          
          # 2. EvoluÃ§Ã£o (Crystallizer + Mutator)
          BRANCH_NAME="auto-evolution/mission-$(date +%s)"
          git checkout -b "$BRANCH_NAME"
          export PYTHONPATH="${PYTHONPATH:+$PYTHONPATH:}$(pwd)"
          
          python app/application/services/crystallization/crystallizer_engine.py
          
          # Nota: Garante que os argumentos do mutator estÃ£o corretos conforme a tua versÃ£o
          python scripts/evolution_mutator.py \
            --strategy "minimal_change" --intent "auto-evolution" \
            --impact "functional-improvement" --roadmap-context "$(cat mission_context.txt)"

          # 3. Ciclo de Auto-Cura (Homeostase Integrada)
          ATTEMPT=1
          while [ $ATTEMPT -le 2 ]; do
            echo "ðŸ§ª Vistoria de Cura - Tentativa $ATTEMPT"
            # Executa pytest. O '|| true' permite que o script continue para tentar a cura
            uv run pytest --json-report --json-report-file=report.json tests/ || true
            
            # VALIDAÃ‡ÃƒO CRÃTICA: Verifica se (failed == 0) E (errors == 0)
            if [ -f report.json ] && \
               [ "$(jq '.summary.failed // 0' report.json)" == "0" ] && \
               [ "$(jq '.summary.errors // 0' report.json)" == "0" ]; then
              echo "âœ… CÃ³digo 100% SaudÃ¡vel (Sem falhas e sem erros de importaÃ§Ã£o)!"
              break
            fi
            
            echo "ðŸ”§ Instabilidade detectada (Falhas: $(jq '.summary.failed // 0' report.json), Erros: $(jq '.summary.errors // 0' report.json))"
            echo "Iniciando Mutator de Cura..."
            uv run python scripts/self_healing_mutator.py --report "report.json"
            
            git add -A
            git commit -m "ðŸ¤– [Auto-Cura] CorreÃ§Ã£o Integrada #$ATTEMPT" || echo "Sem mudanÃ§as"
            ATTEMPT=$((ATTEMPT+1))
          done

          # 4. FinalizaÃ§Ã£o e PR
          git add -A
          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "[Auto-Evolution] DNA EvoluÃ­do e Curado: $ISSUE_BODY"
            git push origin "$BRANCH_NAME"
            gh pr create --title "ðŸ§¬ EvoluÃ§Ã£o Curada: $ISSUE_BODY" \
                         --body "Ciclo completo de evoluÃ§Ã£o e cura realizado nativamente. VerificaÃ§Ã£o de integridade passou em todos os nÃ­veis." \
                         --base main --head "$BRANCH_NAME"
          else
            echo "âš ï¸ Nenhuma mutaÃ§Ã£o detetada para commit."
          fi
