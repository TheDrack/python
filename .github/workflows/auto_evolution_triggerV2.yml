name: Auto Evolution Trigger

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  evolution_cycle:
    name: "ðŸ§¬ Ciclo de EvoluÃ§Ã£o Unificado"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ðŸ“¦ Instalar DependÃªncias (Uma Ãºnica vez)
        run: |
          pip install sqlmodel pydantic requests

      - name: ðŸ§  Fase 1: OrquestraÃ§Ã£o e Sincronia
        id: sync
        run: |
          export PYTHONPATH="${PYTHONPATH:+$PYTHONPATH:}$(pwd)"
          python - << 'PYCODE'
          import os, sys
          try:
              from app.application.services.auto_evolutionV2 import AutoEvolutionServiceV2
              auto = AutoEvolutionServiceV2()
              commit_msg = os.popen("git log -1 --pretty=%B").read()
              
              if "[Auto-Evolution]" in commit_msg:
                  print("ðŸŽ¯ Sincronizando inventÃ¡rio...")
                  next_m = auto.find_next_mission()
                  if next_m and auto.mark_mission_as_completed(next_m['id']):
                      os.system("git config --global user.name 'Jarvis-AutoEvolution'")
                      os.system("git config --global user.email 'jarvis@bot.com'")
                      os.system("git add data/capabilities.json")
                      os.system("git commit -m '[Auto-Evolution] Inventory Synchronized âœ…' || echo 'No changes'")
                      os.system("git push origin main")
                  sys.exit(0) # Para o fluxo aqui apÃ³s sincronizar
              
              print("ðŸš€ Iniciando busca por nova missÃ£o...")
              next_mission = auto.find_next_mission()
              if next_mission:
                  with open('mission_context.txt', 'w') as f:
                      f.write(auto.get_roadmap_context(next_mission))
                  with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                      f.write(f"mission_desc={next_mission['id']}: {next_mission['title']}\n")
                      f.write("run_mutation=true\n")
              else:
                  print("Nenhuma missÃ£o pendente.")
          except Exception as e:
              print(f"Erro na OrquestraÃ§Ã£o: {e}")
              sys.exit(1)
          PYCODE

      - name: ðŸ”¬ Fase 2: AnÃ¡lise de Risco (Metabolismo)
        if: steps.sync.outputs.run_mutation == 'true'
        id: analyzer
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: |
          python scripts/metabolism_analyzer.py \
            --intent "auto-evolution" \
            --instruction "${{ steps.sync.outputs.mission_desc }}" \
            --context "$(cat mission_context.txt)" \
            --repo-path "."

      - name: ðŸ¤– Fase 3: MutaÃ§Ã£o de DNA
        if: steps.sync.outputs.run_mutation == 'true' && steps.analyzer.outputs.requires_human == 'false'
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_BODY: ${{ steps.sync.outputs.mission_desc }}
        run: |
          git config --global user.name "Jarvis-AutoEvolution"
          git config --global user.email "jarvis@bot.com"
          
          BRANCH_NAME="auto-evolution/mission-$(date +%s)"
          git checkout -b "$BRANCH_NAME"
          export PYTHONPATH="${PYTHONPATH:+$PYTHONPATH:}$(pwd)"
          
          python scripts/evolution_mutator.py \
            --strategy "minimal_change" \
            --intent "auto-evolution-mission" \
            --impact "functional-improvement" \
            --roadmap-context "$(cat mission_context.txt)"
          
          git add -A
          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "[Auto-Evolution] DNA Mutated: $ISSUE_BODY"
            git push origin "$BRANCH_NAME"
            gh pr create --title "ðŸ§¬ EvoluÃ§Ã£o: $ISSUE_BODY" \
                         --body "EvoluÃ§Ã£o automÃ¡tica baseada no inventÃ¡rio JSON." \
                         --base main --head "$BRANCH_NAME"
          fi
