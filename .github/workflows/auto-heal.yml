name: Auto-Heal CI Failures

# This workflow automatically attempts to fix CI/CD failures using GitHub Copilot CLI
# DIRECT GITHUB ACTIONS → GITHUB COPILOT INTEGRATION
# 
# When a CI workflow fails, this workflow:
# 1. Downloads the failure logs
# 2. Sends logs to GitHub Copilot CLI for analysis (gh copilot explain)
# 3. Uses Copilot to generate fixes (gh copilot suggest)
# 4. Creates a Pull Request with the proposed fix
#
# Security: Includes infinite loop prevention to avoid continuous failing workflows

on:
  workflow_run:
    workflows: ["Python Tests"]  # Monitor Python Tests workflow for failures
    types:
      - completed

jobs:
  auto-heal:
    # Only run if the workflow failed
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
      issues: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for proper branch operations
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'  # Minimum Python 3.10+
      
      - name: Install GitHub CLI and Copilot extension
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # GitHub CLI is pre-installed on ubuntu-latest runners
          # Verify gh is installed
          gh --version
          
          # Install GitHub Copilot CLI extension
          echo "Installing GitHub Copilot CLI extension..."
          gh extension install github/gh-copilot || echo "Copilot extension already installed"
          
          # Verify Copilot extension is installed
          gh copilot --version || {
            echo "Failed to install GitHub Copilot CLI extension"
            echo "This might be due to permissions or network issues"
            exit 1
          }
      
      - name: Get workflow logs
        id: get-logs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get the logs from the failed workflow
          echo "Fetching logs for workflow run ${{ github.event.workflow_run.id }}..."
          
          # Download logs using GitHub CLI and limit to last 5000 characters
          # to prevent terminal overflow
          LOGS=$(gh run view ${{ github.event.workflow_run.id }} --log 2>&1 || echo "Failed to retrieve logs")
          
          # Truncate to last 5000 characters (most recent errors)
          LOGS_TRUNCATED=$(echo "$LOGS" | tail -c 5000)
          
          # Save to output (handle multiline)
          echo "logs<<EOF" >> $GITHUB_OUTPUT
          echo "$LOGS_TRUNCATED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # Also show preview
          echo "Log preview (first 500 chars):"
          echo "$LOGS_TRUNCATED" | head -c 500
      
      - name: Run auto-fixer with GitHub Copilot
        env:
          # Pass the logs as the issue body
          ISSUE_BODY: ${{ steps.get-logs.outputs.logs }}
          ISSUE_ID: ${{ github.event.workflow_run.id }}
          
          # GitHub token for creating PR and using Copilot
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Running auto-fixer with GitHub Copilot CLI..."
          python scripts/auto_fixer_logic.py
      
      - name: Notify on failure
        if: failure()
        run: |
          echo "⚠️ Auto-fixer failed to create a fix"
          echo "Manual intervention may be required"
          echo "Check the logs above for details"
          echo ""
          echo "Common reasons for failure:"
          echo "  - GitHub Copilot CLI extension not properly installed"
          echo "  - Exceeded maximum auto-healing attempts (prevents infinite loops)"
          echo "  - Unable to identify the file to fix"
          echo "  - Complex error requiring manual intervention"
