name: CI Failure to Issue

# This workflow automatically creates GitHub issues from CI/CD failures
# When a workflow fails, this workflow:
# 1. Extracts the error logs from the failed workflow
# 2. Creates a GitHub issue with the error details
# 3. Labels it with 'jarvis-auto-report' to trigger auto-fix

on:
  workflow_run:
    workflows: ["Python Tests"]  # Monitor Python Tests workflow
    types:
      - completed

jobs:
  create-issue:
    # Only run if the workflow failed
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      issues: write
    
    steps:
      - name: Get workflow information
        id: workflow-info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get workflow run details
          echo "Workflow Run ID: ${{ github.event.workflow_run.id }}"
          echo "Workflow Name: ${{ github.event.workflow_run.name }}"
          echo "Conclusion: ${{ github.event.workflow_run.conclusion }}"
          echo "Branch: ${{ github.event.workflow_run.head_branch }}"
          echo "Commit SHA: ${{ github.event.workflow_run.head_sha }}"
          
          # Get the first 7 characters of the SHA for display
          SHORT_SHA=$(echo "${{ github.event.workflow_run.head_sha }}" | cut -c1-7)
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
      
      - name: Get workflow logs
        id: get-logs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Download logs using GitHub CLI
          echo "Fetching logs for workflow run ${{ github.event.workflow_run.id }}..."
          
          # Get logs and extract relevant error information
          LOGS=$(gh run view ${{ github.event.workflow_run.id }} --log 2>&1 || echo "Failed to retrieve logs")
          
          # Extract last 2000 characters (most recent errors)
          LOGS_TAIL=$(echo "$LOGS" | tail -c 2000)
          
          # Save to output (handle multiline)
          echo "logs<<EOF" >> $GITHUB_OUTPUT
          echo "$LOGS_TAIL" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Create issue from failure
        uses: actions/github-script@v7
        env:
          WORKFLOW_LOGS: ${{ steps.get-logs.outputs.logs }}
        with:
          script: |
            const workflowName = '${{ github.event.workflow_run.name }}';
            const runId = '${{ github.event.workflow_run.id }}';
            const branch = '${{ github.event.workflow_run.head_branch }}';
            const shortSha = '${{ steps.workflow-info.outputs.short_sha }}';
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${runId}`;
            const logs = process.env.WORKFLOW_LOGS || 'No logs available';
            
            // Create issue title
            const title = `ðŸ”´ CI Failure: ${workflowName} failed on ${branch}`;
            
            // Create issue body with error details
            const body = `## CI/CD Workflow Failure Report
            
            **Workflow:** ${workflowName}
            **Branch:** ${branch}
            **Commit:** ${shortSha}
            **Run ID:** ${runId}
            **Run URL:** ${runUrl}
            
            ### Error Logs
            
            \`\`\`
            ${logs}
            \`\`\`
            
            ---
            
            **Action Required:** This issue was automatically created by the CI failure detection system.
            The Jarvis Auto-Fixer will attempt to resolve this issue automatically.
            
            _Generated by CI Failure to Issue Workflow_
            `;
            
            // Check if a similar issue already exists (same workflow, same branch, open)
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'jarvis-auto-report',
            });
            
            // Look for duplicate issues (same workflow name and branch in title)
            const duplicateIssue = existingIssues.data.find(issue => 
              issue.title.includes(workflowName) && 
              issue.title.includes(branch)
            );
            
            if (duplicateIssue) {
              console.log(`Found existing issue #${duplicateIssue.number} for this failure. Adding comment instead.`);
              
              // Add comment to existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: duplicateIssue.number,
                body: `## New Failure Detected\n\n**Run ID:** ${runId}\n**Commit:** ${shortSha}\n**Run URL:** ${runUrl}\n\n### Latest Error Logs\n\n\`\`\`\n${logs}\n\`\`\``
              });
            } else {
              // Create new issue
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['bug', 'jarvis-auto-report']
              });
              
              console.log(`Created issue #${issue.data.number}`);
            }
