name: "ðŸ§¬ JARVIS: Homeostase e Auto-Cura V2"

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened]

jobs:
  homeostasis:
    name: "ðŸ§ª Vistoria e Auto-Cura"
    # Evita loops infinitos de execuÃ§Ãµes automÃ¡ticas
    if: "!contains(github.event.head_commit.message, '[Auto-Cura]')"
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ›°ï¸ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GIT_PAT }}
          # Garante o checkout na branch correta (PR ou Push)
          ref: ${{ github.event.pull_request.head.ref || github.ref }}

      - name: ðŸ“¦ Setup UV
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          python-version: '3.11'

      - name: ðŸ”§ InstalaÃ§Ã£o do DNA
        run: |
          # Limpa o ambiente para evitar erros de persistÃªncia
          uv venv --clear --python 3.11
          
          # Instala apenas o necessÃ¡rio para testes e validaÃ§Ã£o
          uv pip install pytest pytest-json-report pytest-cov sqlmodel groq requests python-dotenv
          
          # Define o PYTHONPATH para que os mÃ³dulos locais sejam encontrados
          echo "PYTHONPATH=$PYTHONPATH:$(pwd)" >> $GITHUB_ENV

      - name: ðŸ”„ Ciclo de Testes e DecisÃ£o
        id: healing_process
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: |
          # 1. Executa a bateria de testes
          # O pytest usarÃ¡ as configuraÃ§Ãµes de cobertura do seu pytest.ini
          uv run pytest --json-report --json-report-file=report.json || true
          
          # 2. Analisa o resultado para decidir o prÃ³ximo passo
          if [ -f report.json ] && [ "$(jq '.summary.failed // 0' report.json)" == "0" ] && [ "$(jq '.summary.errors // 0' report.json)" == "0" ]; then
            echo "âœ… DNA Ã­ntegro. Aprovando para integraÃ§Ã£o."
            echo "final_status=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Falhas detectadas no DNA. Homeostase requer intervenÃ§Ã£o ou auto-cura."
            # O final_status como false impede o merge automÃ¡tico
            echo "final_status=false" >> $GITHUB_OUTPUT
          fi

      - name: âœ… Auto-Merge
        # SÃ³ realiza o merge se os testes passaram e se for uma Pull Request
        if: steps.healing_process.outputs.final_status == 'true' && github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ secrets.GIT_PAT }}
        run: |
          echo "ðŸ«¡ Vistoria concluÃ­da com sucesso. Realizando integraÃ§Ã£o automÃ¡tica..."
          
          # Tenta o merge usando o GIT_PAT via CLI do GitHub
          gh pr merge ${{ github.event.pull_request.number }} --merge --delete-branch --admin || \
          gh pr merge ${{ github.event.pull_request.number }} --merge --delete-branch

      - name: ðŸš¨ EscalaÃ§Ã£o
        # Se os testes falharem, o workflow termina com erro para alertar a entidade
        if: steps.healing_process.outputs.final_status == 'false'
        run: |
          echo "ðŸš¨ O DNA nÃ£o atingiu a homeostase. Verifique os logs de teste abaixo."
          # Exibe um resumo das falhas no log do GitHub Actions para facilitar a leitura
          if [ -f report.json ]; then
            jq '.tests[] | select(.outcome == "failed") | {nodeid, message: .call.crash.message}' report.json
          fi
          exit 1
