name: "ðŸ§¬ JARVIS: Homeostase e Auto-Cura V2"

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened]

jobs:
  homeostasis:
    name: "ðŸ§ª Vistoria e Auto-Cura"
    # Evita loops: nÃ£o executa se o commit for gerado pelo prÃ³prio processo de cura
    if: "!contains(github.event.head_commit.message, '[Auto-Cura]')"
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ›°ï¸ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GIT_PAT }} # Chave mestra para disparar outros fluxos e fazer merge

      - name: ðŸ“¦ Setup UV
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          python-version: '3.11'

      - name: ðŸ”§ InstalaÃ§Ã£o do DNA
        run: |
          # --clear resolve o erro de 'A virtual environment already exists'
          uv venv --clear --python 3.11
          uv pip install pytest pytest-json-report sqlmodel groq requests python-dotenv
          # Registra o PYTHONPATH no ambiente do GitHub Actions
          echo "PYTHONPATH=$PYTHONPATH:$(pwd)" >> $GITHUB_ENV

      - name: ðŸ”„ Ciclo de Cura e DecisÃ£o
        id: healing_process
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: |
          # 1. Executa os testes e gera o relatÃ³rio em JSON
          uv run pytest --json-report --json-report-file=report.json || true
          
          # 2. Verifica se houve falhas ou erros
          if [ -f report.json ] && [ "$(jq '.summary.failed // 0' report.json)" == "0" ] && [ "$(jq '.summary.errors // 0' report.json)" == "0" ]; then
            echo "âœ… DNA Ã­ntegro. Iniciando CristalizaÃ§Ã£o e Auto-Sensing..."
            
            # Roda o Crystallizer para mapear as bibliotecas do cÃ³digo novo (Auto-Sensing)
            uv run python app/application/services/crystallization/crystallizer_engine.py
            
            echo "final_status=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Falhas detectadas no DNA. Iniciando Mutator de Auto-Cura..."
            
            # Aqui entraria o script scripts/self_healing_mutator.py se vocÃª desejar
            echo "final_status=false" >> $GITHUB_OUTPUT
          fi

      - name: âœ… Auto-Merge
        # SÃ“ realiza o merge se for uma PR e os testes passarem (status=true)
        if: steps.healing_process.outputs.final_status == 'true' && github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ secrets.GIT_PAT }}
        run: |
          AUTHOR="${{ github.event.pull_request.user.login }}"
          echo "ðŸ«¡ Vistoria aprovada para $AUTHOR. Realizando Merge AutomÃ¡tico..."
          gh pr merge ${{ github.event.pull_request.number }} --auto --merge --delete-branch

      - name: ðŸ’¾ PersistÃªncia de CristalizaÃ§Ã£o
        # Se os testes passaram, salvamos o mapeamento do Master Crystal no repositÃ³rio
        if: steps.healing_process.outputs.final_status == 'true'
        run: |
          git config --global user.name "Jarvis-Crystallizer"
          git config --global user.email "jarvis@bot.com"
          
          # Adiciona o Master Crystal (com as mapped_libraries) e os Containers atualizados
          git add data/master_crystal.json app/application/containers/*.py
          
          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "chore: [Auto-Cura] DNA Cristalizado e Mapeado [Auto-Cura]"
            git push origin main
          else
            echo "âœ¨ DNA jÃ¡ estÃ¡ em equilÃ­brio."
          fi

      - name: ðŸš¨ EscalaÃ§Ã£o
        # Se falhar e nÃ£o houver cura, abre uma issue (opcional)
        if: steps.healing_process.outputs.final_status == 'false'
        run: |
          echo "ðŸš¨ O sistema nÃ£o conseguiu se auto-curar. Verifique os logs do Pytest."
          exit 1
