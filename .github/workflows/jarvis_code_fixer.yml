name: Jarvis Self-Healing Workshop üîß

# DIRECT GITHUB ISSUES ‚Üí AI INTEGRATION (Bypasses Jarvis Identifier)
# When issues are created with 'jarvis-auto-report' label, they are processed
# directly by the AI without going through Jarvis intent identification.
# User requests through Jarvis API still require intent identification.

on:
  issues:
    types: [opened]

jobs:
  auto_fix:
    if: contains(github.event.issue.labels.*.name, 'jarvis-auto-report')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      - name: Configure Git User
        run: |
          git config --global user.name "Jarvis-Auto-Fixer"
          git config --global user.email "jarvis@bot.com"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          pip install httpx openai groq google-genai 

      - name: Run Auto-Fix Script
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }} 
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: python scripts/auto_fixer_logic.py

      - name: Report Failure to Jarvis
        if: failure() 
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_BODY="O workflow de auto-reparo falhou ao processar a Issue #${{ github.event.issue.number }}.

          ## Logs do Workflow
          Verifique os logs em: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

          ## Poss√≠veis Causas
          1. **Arquivo n√£o identificado**: A issue pode n√£o mencionar o arquivo espec√≠fico a ser modificado.
             - Solu√ß√£o: Inclua o caminho do arquivo na descri√ß√£o (ex: \`scripts/auto_fixer_logic.py\`)
          2. **Falta de contexto**: A descri√ß√£o pode ser muito vaga.
             - Solu√ß√£o: Seja espec√≠fico sobre o que precisa ser alterado
          3. **Problema de API**: As chaves de API podem estar expiradas ou os servi√ßos indispon√≠veis.

          ## Como Ajudar o Auto-Reparo
          Para que o auto-reparo funcione melhor, inclua na issue:
          - ‚úÖ O caminho do arquivo a ser modificado
          - ‚úÖ Palavras-chave relacionadas (ex: 'self-healing', 'github actions', 'api')
          - ‚úÖ Uma descri√ß√£o clara e espec√≠fica do problema ou melhoria

          ---
          *Issue criada automaticamente pelo sistema de auto-reparo*"
          
          gh issue create \
            --title "üî¥ Falha Cr√≠tica no Auto-Fixer: Workflow Failed" \
            --body "$ISSUE_BODY" \
            --label "bug,jarvis-auto-report"
