name: Jarvis Autonomous State Machine

# Self-Healing State Machine Implementation
# Follows the state machine logic for autonomous error fixing:
# - CHANGE_REQUESTED: Auto-fixable errors
# - NEEDS_HUMAN: Infrastructure/unidentified errors
# - SUCCESS: Fix applied successfully  
# - FAILED_LIMIT: Maximum attempts reached

on:
  pull_request:
  issues:
    types: [opened, edited]

jobs:
  healing_engine:
    # Trigger on 'auto-code' or 'jarvis-auto-report' labels for backward compatibility
    if: github.event_name == 'pull_request' || contains(github.event.issue.labels.*.name, 'auto-code') || contains(github.event.issue.labels.*.name, 'jarvis-auto-report')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    outputs:
      final_state: ${{ steps.healing_engine.outputs.final_state }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-json-report

      - name: Run Pytest (The Judge)
        id: tester
        run: |
          pytest --json-report --json-report-file=report.json || echo "TESTS_FAILED=true" >> $GITHUB_ENV
        continue-on-error: true

      - name: Self-Healing Logic
        id: healing_engine
        if: env.TESTS_FAILED == 'true'
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_BODY: ${{ github.event.issue.body || 'Test failures detected' }}
          ISSUE_NUMBER: ${{ github.event.issue.number || github.event.pull_request.number }}
        run: |
          # Install GitHub CLI Copilot extension
          gh --version
          gh extension install github/gh-copilot || echo "Copilot extension already installed"
          
          # Configure Git
          git config --global user.name "Jarvis-Auto-Fixer"
          git config --global user.email "jarvis@bot.com"
          
          # Run auto-fixer with state machine
          python scripts/auto_fixer_logic.py --state report.json

      - name: Final Validation
        if: always()
        run: |
          echo "Estado Final: ${{ steps.healing_engine.outputs.final_state }}"
          # Se o estado for NEEDS_HUMAN ou FAILED_LIMIT, o job deve falhar para avisar o dono
          if [[ "${{ steps.healing_engine.outputs.final_state }}" == "NEEDS_HUMAN" ]] || [[ "${{ steps.healing_engine.outputs.final_state }}" == "FAILED_LIMIT" ]]; then
            echo "‚ö†Ô∏è Human intervention required"
            exit 1
          fi

      - name: Report Failure to Jarvis
        if: failure()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          FINAL_STATE="${{ steps.healing_engine.outputs.final_state }}"
          
          if [[ "$FINAL_STATE" == "FAILED_LIMIT" ]]; then
            TITLE="üî¥ Auto-Repair Failed: Limite de Tentativas Atingido"
            REASON="O sistema atingiu o limite m√°ximo de 3 tentativas de auto-reparo."
          elif [[ "$FINAL_STATE" == "NEEDS_HUMAN" ]]; then
            TITLE="‚ö†Ô∏è Auto-Repair Needs Human: Interven√ß√£o Necess√°ria"
            REASON="Erro de infraestrutura ou erro n√£o identificado detectado."
          else
            TITLE="üî¥ Falha no Auto-Fixer"
            REASON="Falha inesperada no workflow de auto-reparo."
          fi
          
          ISSUE_BODY="## $TITLE

          **Estado Final:** $FINAL_STATE
          **Motivo:** $REASON

          ### Logs do Workflow
          Verifique os logs em: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

          ### Poss√≠veis Causas
          1. **Limite de tentativas excedido** (FAILED_LIMIT): O sistema tentou consertar 3 vezes sem sucesso
             - Solu√ß√£o: Revise as tentativas anteriores e fa√ßa a corre√ß√£o manualmente
          2. **Erro de infraestrutura** (NEEDS_HUMAN): Timeout, ConnectionError, HTTP 429/500/503
             - Solu√ß√£o: Verifique a infraestrutura e conectividade
          3. **Erro n√£o identificado** (NEEDS_HUMAN): Tipo de erro desconhecido pelo sistema
             - Solu√ß√£o: An√°lise manual necess√°ria

          ### Como Ajudar o Auto-Reparo
          Para que o auto-reparo funcione melhor, inclua na issue:
          - ‚úÖ O caminho do arquivo a ser modificado
          - ‚úÖ Tipo de erro (AssertionError, ImportError, NameError, SyntaxError, etc.)
          - ‚úÖ Traceback completo do erro
          - ‚úÖ Uma descri√ß√£o clara do problema

          ---
          *Issue criada automaticamente pelo sistema de auto-reparo*"
          
          gh issue create \
            --title "$TITLE" \
            --body "$ISSUE_BODY" \
            --label "bug,manual-intervention-required"
