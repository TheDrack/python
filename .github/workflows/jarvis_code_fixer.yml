name: Jarvis Self-Healing Workshop üîß

# DIRECT GITHUB ISSUES ‚Üí GITHUB COPILOT INTEGRATION
# When issues are created with 'auto-code' or 'jarvis-auto-report' label,
# they are processed using GitHub Copilot CLI for native ecosystem integration.
#
# Security: Includes infinite loop prevention with maximum retry limits

on:
  issues:
    types: [opened]

jobs:
  auto_fix:
    # Trigger on both 'auto-code' (new label from requirements) and 'jarvis-auto-report' (backward compatibility)
    if: contains(github.event.issue.labels.*.name, 'auto-code') || contains(github.event.issue.labels.*.name, 'jarvis-auto-report')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      - name: Configure Git User
        run: |
          git config --global user.name "Jarvis-Auto-Fixer"
          git config --global user.email "jarvis@bot.com"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install GitHub CLI and Copilot extension
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # GitHub CLI is pre-installed on ubuntu-latest runners
          # Verify gh is installed
          gh --version
          
          # Install GitHub Copilot CLI extension
          echo "Installing GitHub Copilot CLI extension..."
          gh extension install github/gh-copilot || echo "Copilot extension already installed"
          
          # Verify Copilot extension is installed
          gh copilot --version || {
            echo "Failed to install GitHub Copilot CLI extension"
            echo "This might be due to permissions or network issues"
            exit 1
          }

      - name: Run Auto-Fix Script with GitHub Copilot
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: python scripts/auto_fixer_logic.py

      - name: Report Failure to Jarvis
        if: failure() 
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_BODY="O workflow de auto-reparo falhou ao processar a Issue #${{ github.event.issue.number }}.

          ## Logs do Workflow
          Verifique os logs em: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

          ## Poss√≠veis Causas
          1. **Limite de tentativas excedido**: O sistema pode ter atingido o limite m√°ximo de 3 tentativas de auto-reparo para evitar loops infinitos.
             - Solu√ß√£o: Revise as tentativas anteriores e fa√ßa a corre√ß√£o manualmente
          2. **GitHub Copilot CLI n√£o dispon√≠vel**: A extens√£o do Copilot pode n√£o estar instalada ou autenticada.
             - Solu√ß√£o: Verifique os logs do workflow para detalhes
          3. **Arquivo n√£o identificado**: A issue pode n√£o mencionar o arquivo espec√≠fico a ser modificado.
             - Solu√ß√£o: Inclua o caminho do arquivo na descri√ß√£o (ex: \`scripts/auto_fixer_logic.py\`)
          4. **Falta de contexto**: A descri√ß√£o pode ser muito vaga.
             - Solu√ß√£o: Seja espec√≠fico sobre o que precisa ser alterado

          ## Como Ajudar o Auto-Reparo
          Para que o auto-reparo funcione melhor, inclua na issue:
          - ‚úÖ O caminho do arquivo a ser modificado
          - ‚úÖ Palavras-chave relacionadas (ex: 'self-healing', 'github actions', 'api')
          - ‚úÖ Uma descri√ß√£o clara e espec√≠fica do problema ou melhoria

          ---
          *Issue criada automaticamente pelo sistema de auto-reparo*"
          
          gh issue create \
            --title "üî¥ Falha no Auto-Fixer: Issue #${{ github.event.issue.number }}" \
            --body "$ISSUE_BODY" \
            --label "bug,manual-intervention-required"
