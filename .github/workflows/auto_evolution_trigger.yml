name: Auto Evolution Trigger

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  # ==================================================
  # 1. ORQUESTRAÃ‡ÃƒO: Decide se Marca ou se Evolui
  # ==================================================
  process_evolution:
    name: "ðŸ§¬ Orquestrador por Capability"
    runs-on: ubuntu-latest
    outputs:
      should_evolve: ${{ steps.decide.outputs.should_evolve }}
      capability_id: ${{ steps.decide.outputs.capability_id }}
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ðŸ“¦ Instalar DependÃªncias
        run: pip install pydantic sqlmodel requests

      - name: ðŸ§  DecisÃ£o por Capability
        id: decide
        run: |
          export PYTHONPATH="${PYTHONPATH:+$PYTHONPATH:}$(pwd)"
          python - << 'PYCODE'
          import os, re, subprocess
          from app.application.services.auto_evolution import AutoEvolutionService

          auto = AutoEvolutionService()

          commit_msg = subprocess.check_output(
              ["git", "log", "-1", "--pretty=%B"],
              text=True
          )

          is_auto_evolution = "[Auto-Evolution]" in commit_msg

          if is_auto_evolution:
              # extrai capability_id do commit ou PR body
              match = re.search(r"capability_id\s*:\s*(\d+)", commit_msg)
              if not match:
                  raise RuntimeError("capability_id nÃ£o encontrado no commit de auto-evoluÃ§Ã£o")

              capability_id = int(match.group(1))

              auto.mark_capability_completed(
                  capability_id=capability_id,
                  implementation_logic=commit_msg.strip()
              )

              subprocess.run(["git", "config", "--global", "user.name", "Jarvis-AutoEvolution"])
              subprocess.run(["git", "config", "--global", "user.email", "jarvis@bot.com"])
              subprocess.run(["git", "add", "docs/capabilities/capability.json"])
              subprocess.run(["git", "commit", "-m", "[Auto-Evolution] Capability synchronized âœ…"], check=False)
              subprocess.run(["git", "push", "origin", "main"])

              with open(os.environ["GITHUB_OUTPUT"], "a") as f:
                  f.write("should_evolve=false\n")
                  f.write(f"capability_id={capability_id}\n")

          else:
              next_cap = auto.find_next_capability()
              if not next_cap:
                  with open(os.environ["GITHUB_OUTPUT"], "a") as f:
                      f.write("should_evolve=false\n")
              else:
                  with open(os.environ["GITHUB_OUTPUT"], "a") as f:
                      f.write("should_evolve=true\n")
                      f.write(f"capability_id={next_cap['id']}\n")
          PYCODE