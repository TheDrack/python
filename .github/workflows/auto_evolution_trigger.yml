name: Auto Evolution Trigger

# ==================================================
# AUTO-EVOLUTION TRIGGER WORKFLOW
# ==================================================
#
# Este workflow implementa o loop de auto-evolu√ß√£o do Jarvis
# com integra√ß√£o ao sistema de Reinforcement Learning.
#
# L√≥gica:
# 1. Trigger: PR merged para main
# 2. Verifica se o PR N√ÉO √© de auto-evolu√ß√£o (evita loop infinito)
# 3. Se n√£o for auto-evolu√ß√£o:
#    - Busca pr√≥xima miss√£o no ROADMAP.md
#    - Tenta implementar a solu√ß√£o
#    - Executa testes
#    - Se sucesso: recebe recompensa (rewards.py)
#    - Se falha: recebe puni√ß√£o (rewards.py)
#
# ==================================================

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  # ==================================================
  # VERIFICA√á√ÉO: Push para main - Identificar origem
  # ==================================================
  check_trigger_conditions:
    name: "üîç Verificar Condi√ß√µes de Trigger"
    runs-on: ubuntu-latest
    outputs:
      should_evolve: ${{ steps.check.outputs.should_evolve }}
      merge_source: ${{ steps.check.outputs.merge_source }}
      commit_message: ${{ steps.check.outputs.commit_message }}
      
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ github.token }}

      - name: Teste de Identidade
        run: gh auth status
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Instalar depend√™ncias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || echo "Some dependencies failed, continuing..."

      - name: üß¨ Verificar se deve triggar evolu√ß√£o
        id: check
        env:
          COMMIT_MSG: ${{ github.event.head_commit.message }}
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "==================================================" >> $GITHUB_STEP_SUMMARY
          echo "## üß¨ AUTO-EVOLUTION TRIGGER CHECK" >> $GITHUB_STEP_SUMMARY
          echo "==================================================" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "**Push para main detectado**" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Mensagem:** $COMMIT_MSG" >> $GITHUB_STEP_SUMMARY
          echo "**Author:** ${{ github.event.head_commit.author.name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Detectar se o merge veio de auto-evolu√ß√£o atrav√©s de m√∫ltiplos sinais
          IS_AUTO_EVO=false
          
          # Sinal 1: Mensagem de commit cont√©m marcadores de auto-evolu√ß√£o
          if [[ "$COMMIT_MSG" == *"[Auto-Evolution]"* ]] || [[ "$COMMIT_MSG" == *"auto-evolution"* ]]; then
            IS_AUTO_EVO=true
          fi
          
          # Sinal 2: Autor do commit √© o bot de auto-evolu√ß√£o
          if [[ "${{ github.event.head_commit.author.name }}" == "Jarvis-AutoEvolution" ]]; then
            IS_AUTO_EVO=true
          fi
          
          # Sinal 3: Branch name indica auto-evolution
          if [[ "${{ github.event.ref }}" == *"auto-evolution"* ]]; then
            IS_AUTO_EVO=true
          fi
          
          if [ "$IS_AUTO_EVO" = true ]; then
            echo "**Origem:** Merge de Auto-Evolu√ß√£o (pr√≥prio sistema)" >> $GITHUB_STEP_SUMMARY
            echo "**A√ß√£o:** Consolidar conhecimento, N√ÉO criar nova evolu√ß√£o" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Origem:** Merge de PR Externa ou commit manual" >> $GITHUB_STEP_SUMMARY
            echo "**A√ß√£o:** Triggando novo ciclo de evolu√ß√£o" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Define as vari√°veis de forma limpa
          if [ "$IS_AUTO_EVO" = true ]; then
            FINAL_SOURCE="auto-evolution"
            FINAL_EVOLVE="false"
          else
            FINAL_SOURCE="external"
            FINAL_EVOLVE="true"
          fi
          
          # Grava no output usando o formato seguro
          {
            echo "merge_source=$FINAL_SOURCE"
            echo "should_evolve=$FINAL_EVOLVE"
            echo "commit_message<<EOF"
            echo "$COMMIT_MSG"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

  # ==================================================
  # CONSOLIDA√á√ÉO: Atualizar base de conhecimento ap√≥s merge
  # ==================================================
  consolidate_knowledge:
    name: "üìö Consolidar Conhecimento"
    needs: check_trigger_conditions
    if: needs.check_trigger_conditions.outputs.merge_source == 'auto-evolution'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ github.token }}

      - name: Teste de Identidade
        run: gh auth status
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Instalar depend√™ncias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || echo "Some dependencies failed, continuing..."

      - name: üìö Atualizar Base de Conhecimento
        run: |
          echo "==================================================" >> $GITHUB_STEP_SUMMARY
          echo "## üìö CONSOLIDA√á√ÉO DE CONHECIMENTO" >> $GITHUB_STEP_SUMMARY
          echo "==================================================" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "**Origem:** Merge de Auto-Evolu√ß√£o detectado" >> $GITHUB_STEP_SUMMARY
          echo "**A√ß√£o:** Consolidando aprendizado no mapa de conhecimento" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Atualizar mapa de conhecimento/documenta√ß√£o
          export PYTHONPATH="${PYTHONPATH:+$PYTHONPATH:}$(pwd)"
          
          cat > /tmp/consolidate.py << 'PYEND'
          import os
          from datetime import datetime
          
          log_path = 'docs/AUTO_EVOLUTION_LOG.md'
          if os.path.exists(log_path):
              with open(log_path, 'a') as f:
                  f.write('\n\n## Consolida√ß√£o - ' + datetime.now().isoformat() + '\n')
                  f.write('**Status:** Merge para main conclu√≠do com sucesso\n')
                  f.write('**Conhecimento consolidado:** Esta evolu√ß√£o foi integrada ao DNA principal\n')
          print('‚úÖ Base de conhecimento atualizada')
          PYEND
          python3 /tmp/consolidate.py || true
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**‚úÖ Conhecimento consolidado com sucesso**" >> $GITHUB_STEP_SUMMARY

  # ==================================================
  # AN√ÅLISE: Buscar pr√≥xima miss√£o do ROADMAP
  # ==================================================
  find_next_mission:
    name: "üéØ Buscar Pr√≥xima Miss√£o"
    needs: check_trigger_conditions
    if: needs.check_trigger_conditions.outputs.should_evolve == 'true'
    runs-on: ubuntu-latest
    outputs:
      has_mission: ${{ steps.find.outputs.has_mission }}
      mission_description: ${{ steps.find.outputs.mission_description }}
      mission_context: ${{ steps.find.outputs.mission_context }}
      
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ github.token }}

      - name: Teste de Identidade
        run: gh auth status
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Instalar depend√™ncias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || echo "Some dependencies failed, continuing..."

      - name: üéØ Encontrar pr√≥xima miss√£o no ROADMAP
        id: find
        run: |
          echo "==================================================" >> $GITHUB_STEP_SUMMARY
          echo "## üéØ BUSCAR PR√ìXIMA MISS√ÉO DO ROADMAP" >> $GITHUB_STEP_SUMMARY
          echo "==================================================" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          export PYTHONPATH="${PYTHONPATH:+$PYTHONPATH:}$(pwd)"
          set +e
          set -o pipefail
          python - << 'PYCODE' 2>&1 | tee /tmp/find_mission.log
          import json
          import os
          import sys
          
          try:
              from app.application.services.auto_evolution import AutoEvolutionService
          
              auto_evolution = AutoEvolutionService()
          
              # Buscar pr√≥xima miss√£o com auto-complete
              # Este m√©todo detecta miss√µes j√° completas, marca-as automaticamente,
              # e busca a pr√≥xima miss√£o dispon√≠vel
              print('üîç Buscando pr√≥xima miss√£o (com auto-complete)...')
              next_mission = auto_evolution.find_next_mission_with_auto_complete()
          
              if next_mission:
                  mission_data = next_mission['mission']
                  section = next_mission['section']
                  priority = next_mission['priority']
                  
                  print(f'‚úÖ Miss√£o encontrada!')
                  print(f'Se√ß√£o: {section}')
                  print(f'Prioridade: {priority}')
                  print(f'Descri√ß√£o: {mission_data["description"][:100]}...')
                  
                  # Gerar contexto para o GitHub Copilot
                  context = auto_evolution.get_roadmap_context(next_mission)
                  
                  # Salvar outputs (sanitize newlines)
                  with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                      f.write('has_mission=true\n')
                      # Replace newlines with spaces to prevent breaking output format
                      safe_desc = mission_data["description"].replace('\n', ' ')[:200]
                      f.write(f'mission_description={safe_desc}\n')
                  
                  # Salvar contexto em arquivo para pr√≥ximo job
                  with open('mission_context.txt', 'w') as f:
                      f.write(context)
                  
                  # Summary
                  with open(os.environ['GITHUB_STEP_SUMMARY'], 'a') as f:
                      f.write(f'**‚úÖ Miss√£o Encontrada**\n\n')
                      f.write(f'**Se√ß√£o:** {section}\n')
                      f.write(f'**Prioridade:** {priority}\n')
                      f.write(f'**Descri√ß√£o:** {mission_data["description"]}\n')
                      f.write(f'\n**Status:** {mission_data["status"]}\n')
                  
                  sys.exit(0)
              else:
                  print('‚ùå Nenhuma miss√£o encontrada para evoluir')
                  with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                      f.write('has_mission=false\n')
                  
                  with open(os.environ['GITHUB_STEP_SUMMARY'], 'a') as f:
                      f.write('**‚ùå Nenhuma miss√£o encontrada**\n\n')
                      f.write('Todas as miss√µes no ROADMAP est√£o completas ou n√£o h√° miss√µes dispon√≠veis.\n')
                  
                  sys.exit(0)
                  
          except Exception as e:
              print(f'‚ùå ERROR finding next mission: {e}', file=sys.stderr)
              import traceback
              traceback.print_exc()
              
              with open(os.environ.get('GITHUB_OUTPUT', '/dev/null'), 'a') as f:
                  f.write('has_mission=false\n')
              
              sys.exit(1)
          PYCODE
          EXIT_CODE=${PIPESTATUS[0]}
          set -e
          
          # Mostrar log
          cat /tmp/find_mission.log >> $GITHUB_STEP_SUMMARY
          
          if [ $EXIT_CODE -ne 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**‚ùå ERRO ao buscar miss√£o (c√≥digo: $EXIT_CODE)**" >> $GITHUB_STEP_SUMMARY
            exit $EXIT_CODE
          fi

      - name: Upload mission context
        if: steps.find.outputs.has_mission == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: mission-context
          path: mission_context.txt

  # ==================================================
  # EVOLU√á√ÉO: Tentar implementar miss√£o
  # ==================================================
  attempt_evolution:
    name: "üß¨ Tentar Evolu√ß√£o"
    needs: [check_trigger_conditions, find_next_mission]
    if: needs.find_next_mission.outputs.has_mission == 'true'
    runs-on: ubuntu-latest
    outputs:
      evolution_success: ${{ steps.test.outputs.evolution_success }}
      pr_number: ${{ steps.create_pr.outputs.pr_number }}
      
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ github.token }}

      - name: Teste de Identidade
        run: gh auth status
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Instalar depend√™ncias
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-json-report pytest-cov
          pip install -r requirements.txt || echo "Some dependencies failed, continuing..."

      - name: Download mission context
        uses: actions/download-artifact@v4
        with:
          name: mission-context

      - name: Configurar Git
        run: |
          git config --global user.name "Jarvis-AutoEvolution"
          git config --global user.email "jarvis-evolution@bot.com"

      - name: üå± Criar branch de evolu√ß√£o
        id: branch
        run: |
          TIMESTAMP=$(date +%s)
          BRANCH_NAME="auto-evolution/mission-${TIMESTAMP}"
          git checkout -b "$BRANCH_NAME"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          
          echo "**Branch:** \`$BRANCH_NAME\`" >> $GITHUB_STEP_SUMMARY

      - name: ü§ñ Implementar Miss√£o via Metabolism Mutator
        id: implement
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          MISSION_DESC: ${{ needs.find_next_mission.outputs.mission_description }}
        run: |
          echo "==================================================" >> $GITHUB_STEP_SUMMARY
          echo "## ü§ñ IMPLEMENTA√á√ÉO DA MISS√ÉO" >> $GITHUB_STEP_SUMMARY
          echo "==================================================" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Ler contexto da miss√£o
          ROADMAP_CONTEXT=""
          if [ -f mission_context.txt ]; then
            cat mission_context.txt >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            ROADMAP_CONTEXT=$(cat mission_context.txt)
          fi
          
          # Usar o metabolism_mutator para implementar a miss√£o
          export PYTHONPATH="${PYTHONPATH:+$PYTHONPATH:}$(pwd)"
          export ISSUE_BODY="$MISSION_DESC"
          export ISSUE_NUMBER="auto-evolution"
          
          echo "**üìù Aplicando muta√ß√£o autom√°tica para miss√£o do ROADMAP...**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          set +e
          OUTPUT=$(python scripts/metabolism_mutator.py \
            --strategy "minimal_change" \
            --intent "implementa√ß√£o" \
            --impact "funcional" \
            --roadmap-context "$ROADMAP_CONTEXT" 2>&1)
          EXIT_CODE=$?
          set -e
          
          # Mostrar sa√≠da (√∫ltimas 50 linhas para evitar logs excessivamente longos)
          MAX_OUTPUT_LINES=50
          echo "$OUTPUT"
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Sa√≠da da Implementa√ß√£o" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "$OUTPUT" | tail -n $MAX_OUTPUT_LINES >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          # Atualizar AUTO_EVOLUTION_LOG
          echo "# Auto-Evolution Mission" > docs/AUTO_EVOLUTION_LOG.md
          echo "" >> docs/AUTO_EVOLUTION_LOG.md
          echo "**Mission attempted at:** $(date)" >> docs/AUTO_EVOLUTION_LOG.md
          echo "" >> docs/AUTO_EVOLUTION_LOG.md
          echo "**Status:** Muta√ß√£o aplicada via metabolism_mutator.py" >> docs/AUTO_EVOLUTION_LOG.md
          echo "" >> docs/AUTO_EVOLUTION_LOG.md
          cat mission_context.txt >> docs/AUTO_EVOLUTION_LOG.md
          
          # Commitar mudan√ßas
          git add .
          git commit -m "[Auto-Evolution] Attempting mission from ROADMAP" || true
          
          if [ $EXIT_CODE -ne 0 ]; then
            echo "**‚ö†Ô∏è Implementa√ß√£o parcial - requer revis√£o humana**" >> $GITHUB_STEP_SUMMARY
          else
            echo "**‚úÖ Implementa√ß√£o conclu√≠da**" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ‚úÖ Valida√ß√£o Pr√©-PR - Verificar Mudan√ßas Reais
        id: validate
        run: |
          echo "==================================================" >> $GITHUB_STEP_SUMMARY
          echo "## ‚úÖ VALIDA√á√ÉO PR√â-PR" >> $GITHUB_STEP_SUMMARY
          echo "==================================================" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Verificar se h√° mudan√ßas reais no c√≥digo via git diff
          git add -A
          
          # Obter diff (excluindo arquivos de log tempor√°rios)
          if git diff --cached --quiet --exit-code; then
            echo "**‚ùå FALHA: Nenhuma mudan√ßa t√©cnica detectada**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "A muta√ß√£o n√£o gerou nenhuma altera√ß√£o no c√≥digo." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Evolu√ß√£o abortada: Nenhuma melhoria t√©cnica foi gerada.**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 1
          else
            # H√° mudan√ßas - mostrar estat√≠sticas
            STATS=$(git diff --cached --stat)
            echo "**‚úÖ MUDAN√áAS DETECTADAS**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$STATS" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Contar arquivos modificados
            FILES_CHANGED=$(git diff --cached --name-only | wc -l)
            echo "**Arquivos modificados:** $FILES_CHANGED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: üß™ Executar testes
        id: test
        if: steps.validate.outputs.has_changes == 'true'
        continue-on-error: true
        run: |
          echo "==================================================" >> $GITHUB_STEP_SUMMARY
          echo "## üß™ EXECUTAR TESTES" >> $GITHUB_STEP_SUMMARY
          echo "==================================================" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Executar testes
          if pytest --json-report --json-report-file=test_report.json; then
            echo "evolution_success=true" >> $GITHUB_OUTPUT
            echo "**‚úÖ TESTES PASSARAM**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "A evolu√ß√£o foi bem-sucedida! Recompensa ser√° registrada." >> $GITHUB_STEP_SUMMARY
          else
            echo "evolution_success=false" >> $GITHUB_OUTPUT
            echo "**‚ùå TESTES FALHARAM**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "A evolu√ß√£o falhou. Puni√ß√£o ser√° registrada." >> $GITHUB_STEP_SUMMARY
          fi

      - name: üì§ Push branch
        if: steps.validate.outputs.has_changes == 'true'
        run: |
          git push origin "$BRANCH_NAME"

      - name: üìù Criar Pull Request
        id: create_pr
        if: steps.validate.outputs.has_changes == 'true'
        env:
          GITHUB_TOKEN: ${{ github.token }}
          GH_TOKEN: ${{ github.token }}
          MISSION_DESC: ${{ needs.find_next_mission.outputs.mission_description }}
          COMMIT_SHA: ${{ github.sha }}
        run: |
          # Create PR body in a temp file to avoid shell injection
          BODY_FILE="$(mktemp)"
          {
            printf '%s\n' "## üß¨ Auto-Evolution Mission"
            printf '\n'
            printf '%s\n' "Esta PR foi criada automaticamente pelo sistema de auto-evolu√ß√£o do Jarvis."
            printf '\n'
            printf '%s\n' "### Miss√£o do ROADMAP"
            printf '%s\n' "$MISSION_DESC"
            printf '\n'
            printf '%s\n' "### Contexto"
            printf '%s\n' "Ver arquivo \`docs/AUTO_EVOLUTION_LOG.md\` para detalhes completos da miss√£o."
            printf '\n'
            printf '%s\n' "### Status dos Testes"
            printf '%s\n' "Testes foram executados automaticamente. Ver workflow para resultados."
            printf '\n'
            printf '%s\n' "### Reinforcement Learning"
            printf '%s\n' "- Sucesso: +50 pontos (deploy_success)"
            printf '%s\n' "- Falha: -25 pontos (deploy_fail)"
            printf '\n'
            printf '%s\n' "---"
            printf '\n'
            printf '%s\n' "_Criado automaticamente pelo workflow auto_evolution_trigger.yml_"
            printf '%s\n' "_Triggered por: Push to main (${COMMIT_SHA:0:7})_"
          } > "$BODY_FILE"
          
          PR_TITLE="[Auto-Evolution] ${MISSION_DESC:0:80}"
          
          # Criar PR
          gh pr create \
            --repo "${{ github.repository }}" \
            --title "$PR_TITLE" \
            --body-file "$BODY_FILE" \
            --base main \
            --head "$BRANCH_NAME"
          
          # Cleanup
          rm -f "$BODY_FILE"
          
          # Obter n√∫mero da PR criada
          PR_NUMBER=$(gh pr view "$BRANCH_NAME" --repo "${{ github.repository }}" --json number -q .number)
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          
          echo "**‚úÖ Pull Request criada:** #$PR_NUMBER" >> $GITHUB_STEP_SUMMARY

  # ==================================================
  # RECOMPENSA/PUNI√á√ÉO: Registrar no RL system
  # ==================================================
  log_evolution_result:
    name: "üìä Registrar Resultado no RL"
    needs: [find_next_mission, attempt_evolution]
    if: always() && needs.find_next_mission.outputs.has_mission == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
        with:
          token: ${{ github.token }}

      - name: Teste de Identidade
        run: gh auth status
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Instalar depend√™ncias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || echo "Some dependencies failed, continuing..."

      - name: üìä Registrar recompensa/puni√ß√£o
        env:
          EVOLUTION_SUCCESS: ${{ needs.attempt_evolution.outputs.evolution_success }}
          PR_NUMBER: ${{ needs.attempt_evolution.outputs.pr_number }}
          MISSION_DESC: ${{ needs.find_next_mission.outputs.mission_description }}
          WORKFLOW_RUN: ${{ github.run_id }}
        run: |
          echo "==================================================" >> $GITHUB_STEP_SUMMARY
          echo "## üìä REINFORCEMENT LEARNING - RESULTADO" >> $GITHUB_STEP_SUMMARY
          echo "==================================================" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          export PYTHONPATH="${PYTHONPATH:+$PYTHONPATH:}$(pwd)"
          set +e
          set -o pipefail
          python - << 'PYCODE' 2>&1 | tee /tmp/rl_result.log
          import os
          import sys
          
          try:
              from app.adapters.infrastructure.sqlite_history_adapter import SQLiteHistoryAdapter
              from app.adapters.infrastructure.reward_adapter import RewardAdapter
              from app.application.services.evolution_loop import EvolutionLoopService
              from app.core.config import settings
          
              # Inicializar servi√ßos
              db_adapter = SQLiteHistoryAdapter(database_url=settings.database_url)
              reward_adapter = RewardAdapter(engine=db_adapter.engine)
              evolution_service = EvolutionLoopService(reward_provider=reward_adapter)
              
              success = os.environ.get('EVOLUTION_SUCCESS') == 'true'
              pr_number = os.environ.get('PR_NUMBER', 'unknown')
              mission_desc = os.environ.get('MISSION_DESC', 'unknown')
              workflow_run = os.environ.get('WORKFLOW_RUN', 'unknown')
              
              # Registrar resultado
              reward_id = evolution_service.log_deploy_result(
                  success=success,
                  deployment_id=f'auto-evolution-pr-{pr_number}',
                  metadata={
                      'type': 'auto_evolution',
                      'mission': mission_desc,
                      'pr_number': pr_number,
                      'workflow_run': workflow_run
                  }
              )
              
              if success:
                  print('‚úÖ Recompensa registrada: +50 pontos (deploy_success)')
                  print(f'Reward ID: {reward_id}')
              else:
                  print('‚ùå Puni√ß√£o registrada: -25 pontos (deploy_fail)')
                  print(f'Reward ID: {reward_id}')
              
              # Obter status de evolu√ß√£o
              status = evolution_service.get_evolution_status(days=7)
              print(f'\n{status["commander_message"]}')
              
              sys.exit(0)
              
          except Exception as e:
              print(f'‚ö†Ô∏è Error registering RL result: {e}', file=sys.stderr)
              import traceback
              traceback.print_exc()
              print('Continuing without reward registration...')
              sys.exit(0)  # Don't fail the workflow if RL fails
          PYCODE
          EXIT_CODE=${PIPESTATUS[0]}
          set -e
          
          # Mostrar resultado
          cat /tmp/rl_result.log >> $GITHUB_STEP_SUMMARY
          
          # N√£o falhar o workflow se RL falhar
          exit 0

  # ==================================================
  # RESUMO: Status final
  # ==================================================
  summary:
    name: "üìã Resumo da Auto-Evolu√ß√£o"
    needs: [check_trigger_conditions, consolidate_knowledge, find_next_mission, attempt_evolution, log_evolution_result]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: üìã Gerar resumo
        run: |
          echo "==================================================" >> $GITHUB_STEP_SUMMARY
          echo "## üìã RESUMO DO CICLO DE AUTO-EVOLU√á√ÉO" >> $GITHUB_STEP_SUMMARY
          echo "==================================================" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "**Trigger:** Push para main - ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Origem do Merge:** ${{ needs.check_trigger_conditions.outputs.merge_source }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deve Evoluir:** ${{ needs.check_trigger_conditions.outputs.should_evolve }}" >> $GITHUB_STEP_SUMMARY
          echo "**Miss√£o Encontrada:** ${{ needs.find_next_mission.outputs.has_mission || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Evolu√ß√£o Bem-Sucedida:** ${{ needs.attempt_evolution.outputs.evolution_success || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Princ√≠pios da Auto-Evolu√ß√£o:**" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Toda evolu√ß√£o √© triggada por push para main" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Detecta origem do merge (auto-evolu√ß√£o vs externa)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Consolida conhecimento em merges de auto-evolu√ß√£o" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Miss√µes priorizadas por se√ß√£o do ROADMAP" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Reinforcement Learning integrado (rewards/punishments)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Comandante pode revisar todas as PRs de evolu√ß√£o" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "_Sistema de Auto-Evolu√ß√£o do Jarvis com Reinforcement Learning_" >> $GITHUB_STEP_SUMMARY
