name: Auto Evolution Trigger

# ==================================================
# AUTO-EVOLUTION TRIGGER WORKFLOW
# ==================================================
#
# Este workflow implementa o loop de auto-evoluÃ§Ã£o do Jarvis
# com integraÃ§Ã£o ao sistema de Reinforcement Learning.
#
# LÃ³gica:
# 1. Trigger: PR merged para main
# 2. Verifica se o PR NÃƒO Ã© de auto-evoluÃ§Ã£o (evita loop infinito)
# 3. Se nÃ£o for auto-evoluÃ§Ã£o:
#    - Busca prÃ³xima missÃ£o no ROADMAP.md
#    - Tenta implementar a soluÃ§Ã£o
#    - Executa testes
#    - Se sucesso: recebe recompensa (rewards.py)
#    - Se falha: recebe puniÃ§Ã£o (rewards.py)
#
# ==================================================

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  # ==================================================
  # VERIFICAÃ‡ÃƒO: Push para main - Identificar origem
  # ==================================================
  check_trigger_conditions:
    name: "ðŸ” Verificar CondiÃ§Ãµes de Trigger"
    runs-on: ubuntu-latest
    outputs:
      should_evolve: ${{ steps.check.outputs.should_evolve }}
      merge_source: ${{ steps.check.outputs.merge_source }}
      commit_message: ${{ steps.check.outputs.commit_message }}
      
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ github.token }}

      - name: Teste de Identidade
        run: gh auth status
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Instalar dependÃªncias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || echo "Some dependencies failed, continuing..."

      - name: ðŸ§¬ Verificar se deve triggar evoluÃ§Ã£o
        id: check
        env:
          COMMIT_MSG: ${{ github.event.head_commit.message }}
        run: |
          echo "==================================================" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ§¬ AUTO-EVOLUTION TRIGGER CHECK" >> $GITHUB_STEP_SUMMARY
          echo "==================================================" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "**Push para main detectado**" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Mensagem:** $COMMIT_MSG" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Detectar se o merge veio de auto-evoluÃ§Ã£o ou PR externa
          if [[ "$COMMIT_MSG" == *"[Auto-Evolution]"* ]] || [[ "$COMMIT_MSG" == *"auto-evolution"* ]]; then
            echo "**Origem:** Merge de Auto-EvoluÃ§Ã£o (prÃ³prio sistema)" >> $GITHUB_STEP_SUMMARY
            echo "**AÃ§Ã£o:** Consolidar conhecimento, NÃƒO criar nova evoluÃ§Ã£o" >> $GITHUB_STEP_SUMMARY
            echo "merge_source=auto-evolution" >> $GITHUB_OUTPUT
            echo "should_evolve=false" >> $GITHUB_OUTPUT
          else
            echo "**Origem:** Merge de PR Externa ou commit manual" >> $GITHUB_STEP_SUMMARY
            echo "**AÃ§Ã£o:** Triggando novo ciclo de evoluÃ§Ã£o" >> $GITHUB_STEP_SUMMARY
            echo "merge_source=external" >> $GITHUB_OUTPUT
            echo "should_evolve=true" >> $GITHUB_OUTPUT
          fi
          
          echo "commit_message=$COMMIT_MSG" >> $GITHUB_OUTPUT

  # ==================================================
  # CONSOLIDAÃ‡ÃƒO: Atualizar base de conhecimento apÃ³s merge
  # ==================================================
  consolidate_knowledge:
    name: "ðŸ“š Consolidar Conhecimento"
    needs: check_trigger_conditions
    if: needs.check_trigger_conditions.outputs.merge_source == 'auto-evolution'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ github.token }}

      - name: Teste de Identidade
        run: gh auth status
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Instalar dependÃªncias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || echo "Some dependencies failed, continuing..."

      - name: ðŸ“š Atualizar Base de Conhecimento
        run: |
          echo "==================================================" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“š CONSOLIDAÃ‡ÃƒO DE CONHECIMENTO" >> $GITHUB_STEP_SUMMARY
          echo "==================================================" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "**Origem:** Merge de Auto-EvoluÃ§Ã£o detectado" >> $GITHUB_STEP_SUMMARY
          echo "**AÃ§Ã£o:** Consolidando aprendizado no mapa de conhecimento" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Atualizar mapa de conhecimento/documentaÃ§Ã£o
          export PYTHONPATH="${PYTHONPATH:+$PYTHONPATH:}$(pwd)"
          
          cat > /tmp/consolidate.py << 'PYEND'
          import os
          from datetime import datetime
          
          log_path = 'docs/AUTO_EVOLUTION_LOG.md'
          if os.path.exists(log_path):
              with open(log_path, 'a') as f:
                  f.write('\n\n## ConsolidaÃ§Ã£o - ' + datetime.now().isoformat() + '\n')
                  f.write('**Status:** Merge para main concluÃ­do com sucesso\n')
                  f.write('**Conhecimento consolidado:** Esta evoluÃ§Ã£o foi integrada ao DNA principal\n')
          print('âœ… Base de conhecimento atualizada')
          PYEND
          python3 /tmp/consolidate.py || true
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**âœ… Conhecimento consolidado com sucesso**" >> $GITHUB_STEP_SUMMARY

  # ==================================================
  # ANÃLISE: Buscar prÃ³xima missÃ£o do ROADMAP
  # ==================================================
  find_next_mission:
    name: "ðŸŽ¯ Buscar PrÃ³xima MissÃ£o"
    needs: check_trigger_conditions
    if: needs.check_trigger_conditions.outputs.should_evolve == 'true'
    runs-on: ubuntu-latest
    outputs:
      has_mission: ${{ steps.find.outputs.has_mission }}
      mission_description: ${{ steps.find.outputs.mission_description }}
      mission_context: ${{ steps.find.outputs.mission_context }}
      
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ github.token }}

      - name: Teste de Identidade
        run: gh auth status
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Instalar dependÃªncias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || echo "Some dependencies failed, continuing..."

      - name: ðŸŽ¯ Encontrar prÃ³xima missÃ£o no ROADMAP
        id: find
        run: |
          echo "==================================================" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸŽ¯ BUSCAR PRÃ“XIMA MISSÃƒO DO ROADMAP" >> $GITHUB_STEP_SUMMARY
          echo "==================================================" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          export PYTHONPATH="${PYTHONPATH:+$PYTHONPATH:}$(pwd)"
          set +e
          set -o pipefail
          python - << 'PYCODE' 2>&1 | tee /tmp/find_mission.log
          import json
          import os
          import sys
          
          try:
              from app.application.services.auto_evolution import AutoEvolutionService
          
              auto_evolution = AutoEvolutionService()
          
              # Buscar prÃ³xima missÃ£o
              next_mission = auto_evolution.find_next_mission()
          
              if next_mission:
                  mission_data = next_mission['mission']
                  section = next_mission['section']
                  priority = next_mission['priority']
                  
                  print(f'âœ… MissÃ£o encontrada!')
                  print(f'SeÃ§Ã£o: {section}')
                  print(f'Prioridade: {priority}')
                  print(f'DescriÃ§Ã£o: {mission_data["description"][:100]}...')
                  
                  # Gerar contexto para o GitHub Copilot
                  context = auto_evolution.get_roadmap_context(next_mission)
                  
                  # Salvar outputs (sanitize newlines)
                  with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                      f.write('has_mission=true\n')
                      # Replace newlines with spaces to prevent breaking output format
                      safe_desc = mission_data["description"].replace('\n', ' ')[:200]
                      f.write(f'mission_description={safe_desc}\n')
                  
                  # Salvar contexto em arquivo para prÃ³ximo job
                  with open('mission_context.txt', 'w') as f:
                      f.write(context)
                  
                  # Summary
                  with open(os.environ['GITHUB_STEP_SUMMARY'], 'a') as f:
                      f.write(f'**âœ… MissÃ£o Encontrada**\n\n')
                      f.write(f'**SeÃ§Ã£o:** {section}\n')
                      f.write(f'**Prioridade:** {priority}\n')
                      f.write(f'**DescriÃ§Ã£o:** {mission_data["description"]}\n')
                      f.write(f'\n**Status:** {mission_data["status"]}\n')
                  
                  sys.exit(0)
              else:
                  print('âŒ Nenhuma missÃ£o encontrada para evoluir')
                  with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                      f.write('has_mission=false\n')
                  
                  with open(os.environ['GITHUB_STEP_SUMMARY'], 'a') as f:
                      f.write('**âŒ Nenhuma missÃ£o encontrada**\n\n')
                      f.write('Todas as missÃµes no ROADMAP estÃ£o completas ou nÃ£o hÃ¡ missÃµes disponÃ­veis.\n')
                  
                  sys.exit(0)
                  
          except Exception as e:
              print(f'âŒ ERROR finding next mission: {e}', file=sys.stderr)
              import traceback
              traceback.print_exc()
              
              with open(os.environ.get('GITHUB_OUTPUT', '/dev/null'), 'a') as f:
                  f.write('has_mission=false\n')
              
              sys.exit(1)
          PYCODE
          EXIT_CODE=${PIPESTATUS[0]}
          set -e
          
          # Mostrar log
          cat /tmp/find_mission.log >> $GITHUB_STEP_SUMMARY
          
          if [ $EXIT_CODE -ne 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**âŒ ERRO ao buscar missÃ£o (cÃ³digo: $EXIT_CODE)**" >> $GITHUB_STEP_SUMMARY
            exit $EXIT_CODE
          fi

      - name: Upload mission context
        if: steps.find.outputs.has_mission == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: mission-context
          path: mission_context.txt

  # ==================================================
  # EVOLUÃ‡ÃƒO: Tentar implementar missÃ£o
  # ==================================================
  attempt_evolution:
    name: "ðŸ§¬ Tentar EvoluÃ§Ã£o"
    needs: [check_trigger_conditions, find_next_mission]
    if: needs.find_next_mission.outputs.has_mission == 'true'
    runs-on: ubuntu-latest
    outputs:
      evolution_success: ${{ steps.test.outputs.evolution_success }}
      pr_number: ${{ steps.create_pr.outputs.pr_number }}
      
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ github.token }}

      - name: Teste de Identidade
        run: gh auth status
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Instalar dependÃªncias
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-json-report pytest-cov
          pip install -r requirements.txt || echo "Some dependencies failed, continuing..."

      - name: Download mission context
        uses: actions/download-artifact@v4
        with:
          name: mission-context

      - name: Configurar Git
        run: |
          git config --global user.name "Jarvis-AutoEvolution"
          git config --global user.email "jarvis-evolution@bot.com"

      - name: ðŸŒ± Criar branch de evoluÃ§Ã£o
        id: branch
        run: |
          TIMESTAMP=$(date +%s)
          BRANCH_NAME="auto-evolution/mission-${TIMESTAMP}"
          git checkout -b "$BRANCH_NAME"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          
          echo "**Branch:** \`$BRANCH_NAME\`" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ¤– Implementar MissÃ£o via Metabolism Mutator
        id: implement
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          MISSION_DESC: ${{ needs.find_next_mission.outputs.mission_description }}
        run: |
          echo "==================================================" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ¤– IMPLEMENTAÃ‡ÃƒO DA MISSÃƒO" >> $GITHUB_STEP_SUMMARY
          echo "==================================================" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Ler contexto da missÃ£o
          if [ -f mission_context.txt ]; then
            cat mission_context.txt >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Usar o metabolism_mutator para implementar a missÃ£o
          export PYTHONPATH="${PYTHONPATH:+$PYTHONPATH:}$(pwd)"
          export ISSUE_BODY="$MISSION_DESC"
          export ISSUE_NUMBER="auto-evolution"
          
          echo "**ðŸ“ Aplicando mutaÃ§Ã£o automÃ¡tica para missÃ£o do ROADMAP...**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          set +e
          OUTPUT=$(python scripts/metabolism_mutator.py \
            --strategy "minimal_change" \
            --intent "implementaÃ§Ã£o" \
            --impact "funcional" 2>&1)
          EXIT_CODE=$?
          set -e
          
          # Mostrar saÃ­da (Ãºltimas 50 linhas para evitar logs excessivamente longos)
          MAX_OUTPUT_LINES=50
          echo "$OUTPUT"
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### SaÃ­da da ImplementaÃ§Ã£o" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "$OUTPUT" | tail -n $MAX_OUTPUT_LINES >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          # Atualizar AUTO_EVOLUTION_LOG
          echo "# Auto-Evolution Mission" > docs/AUTO_EVOLUTION_LOG.md
          echo "" >> docs/AUTO_EVOLUTION_LOG.md
          echo "**Mission attempted at:** $(date)" >> docs/AUTO_EVOLUTION_LOG.md
          echo "" >> docs/AUTO_EVOLUTION_LOG.md
          echo "**Status:** MutaÃ§Ã£o aplicada via metabolism_mutator.py" >> docs/AUTO_EVOLUTION_LOG.md
          echo "" >> docs/AUTO_EVOLUTION_LOG.md
          cat mission_context.txt >> docs/AUTO_EVOLUTION_LOG.md
          
          # Commitar mudanÃ§as
          git add .
          git commit -m "[Auto-Evolution] Attempting mission from ROADMAP" || true
          
          if [ $EXIT_CODE -ne 0 ]; then
            echo "**âš ï¸ ImplementaÃ§Ã£o parcial - requer revisÃ£o humana**" >> $GITHUB_STEP_SUMMARY
          else
            echo "**âœ… ImplementaÃ§Ã£o concluÃ­da**" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸ§ª Executar testes
        id: test
        continue-on-error: true
        run: |
          echo "==================================================" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ§ª EXECUTAR TESTES" >> $GITHUB_STEP_SUMMARY
          echo "==================================================" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Executar testes
          if pytest --json-report --json-report-file=test_report.json; then
            echo "evolution_success=true" >> $GITHUB_OUTPUT
            echo "**âœ… TESTES PASSARAM**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "A evoluÃ§Ã£o foi bem-sucedida! Recompensa serÃ¡ registrada." >> $GITHUB_STEP_SUMMARY
          else
            echo "evolution_success=false" >> $GITHUB_OUTPUT
            echo "**âŒ TESTES FALHARAM**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "A evoluÃ§Ã£o falhou. PuniÃ§Ã£o serÃ¡ registrada." >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸ“¤ Push branch
        run: |
          git push origin "$BRANCH_NAME"

      - name: ðŸ“ Criar Pull Request
        id: create_pr
        env:
          GITHUB_TOKEN: ${{ github.token }}
          GH_TOKEN: ${{ github.token }}
          MISSION_DESC: ${{ needs.find_next_mission.outputs.mission_description }}
          COMMIT_SHA: ${{ github.sha }}
        run: |
          # Create PR body in a temp file to avoid shell injection
          BODY_FILE="$(mktemp)"
          {
            printf '%s\n' "## ðŸ§¬ Auto-Evolution Mission"
            printf '\n'
            printf '%s\n' "Esta PR foi criada automaticamente pelo sistema de auto-evoluÃ§Ã£o do Jarvis."
            printf '\n'
            printf '%s\n' "### MissÃ£o do ROADMAP"
            printf '%s\n' "$MISSION_DESC"
            printf '\n'
            printf '%s\n' "### Contexto"
            printf '%s\n' "Ver arquivo \`docs/AUTO_EVOLUTION_LOG.md\` para detalhes completos da missÃ£o."
            printf '\n'
            printf '%s\n' "### Status dos Testes"
            printf '%s\n' "Testes foram executados automaticamente. Ver workflow para resultados."
            printf '\n'
            printf '%s\n' "### Reinforcement Learning"
            printf '%s\n' "- Sucesso: +50 pontos (deploy_success)"
            printf '%s\n' "- Falha: -25 pontos (deploy_fail)"
            printf '\n'
            printf '%s\n' "---"
            printf '\n'
            printf '%s\n' "_Criado automaticamente pelo workflow auto_evolution_trigger.yml_"
            printf '%s\n' "_Triggered por: Push to main (${COMMIT_SHA:0:7})_"
          } > "$BODY_FILE"
          
          PR_TITLE="[Auto-Evolution] ${MISSION_DESC:0:80}"
          
          # Criar PR
          gh pr create \
            --repo "${{ github.repository }}" \
            --title "$PR_TITLE" \
            --body-file "$BODY_FILE" \
            --base main \
            --head "$BRANCH_NAME"
          
          # Cleanup
          rm -f "$BODY_FILE"
          
          # Obter nÃºmero da PR criada
          PR_NUMBER=$(gh pr view "$BRANCH_NAME" --repo "${{ github.repository }}" --json number -q .number)
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          
          echo "**âœ… Pull Request criada:** #$PR_NUMBER" >> $GITHUB_STEP_SUMMARY

  # ==================================================
  # RECOMPENSA/PUNIÃ‡ÃƒO: Registrar no RL system
  # ==================================================
  log_evolution_result:
    name: "ðŸ“Š Registrar Resultado no RL"
    needs: [find_next_mission, attempt_evolution]
    if: always() && needs.find_next_mission.outputs.has_mission == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          token: ${{ github.token }}

      - name: Teste de Identidade
        run: gh auth status
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Instalar dependÃªncias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || echo "Some dependencies failed, continuing..."

      - name: ðŸ“Š Registrar recompensa/puniÃ§Ã£o
        env:
          EVOLUTION_SUCCESS: ${{ needs.attempt_evolution.outputs.evolution_success }}
          PR_NUMBER: ${{ needs.attempt_evolution.outputs.pr_number }}
          MISSION_DESC: ${{ needs.find_next_mission.outputs.mission_description }}
          WORKFLOW_RUN: ${{ github.run_id }}
        run: |
          echo "==================================================" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š REINFORCEMENT LEARNING - RESULTADO" >> $GITHUB_STEP_SUMMARY
          echo "==================================================" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          export PYTHONPATH="${PYTHONPATH:+$PYTHONPATH:}$(pwd)"
          set +e
          set -o pipefail
          python - << 'PYCODE' 2>&1 | tee /tmp/rl_result.log
          import os
          import sys
          
          try:
              from app.adapters.infrastructure.sqlite_history_adapter import SQLiteHistoryAdapter
              from app.adapters.infrastructure.reward_adapter import RewardAdapter
              from app.application.services.evolution_loop import EvolutionLoopService
              from app.core.config import settings
          
              # Inicializar serviÃ§os
              db_adapter = SQLiteHistoryAdapter(database_url=settings.database_url)
              reward_adapter = RewardAdapter(engine=db_adapter.engine)
              evolution_service = EvolutionLoopService(reward_provider=reward_adapter)
              
              success = os.environ.get('EVOLUTION_SUCCESS') == 'true'
              pr_number = os.environ.get('PR_NUMBER', 'unknown')
              mission_desc = os.environ.get('MISSION_DESC', 'unknown')
              workflow_run = os.environ.get('WORKFLOW_RUN', 'unknown')
              
              # Registrar resultado
              reward_id = evolution_service.log_deploy_result(
                  success=success,
                  deployment_id=f'auto-evolution-pr-{pr_number}',
                  metadata={
                      'type': 'auto_evolution',
                      'mission': mission_desc,
                      'pr_number': pr_number,
                      'workflow_run': workflow_run
                  }
              )
              
              if success:
                  print('âœ… Recompensa registrada: +50 pontos (deploy_success)')
                  print(f'Reward ID: {reward_id}')
              else:
                  print('âŒ PuniÃ§Ã£o registrada: -25 pontos (deploy_fail)')
                  print(f'Reward ID: {reward_id}')
              
              # Obter status de evoluÃ§Ã£o
              status = evolution_service.get_evolution_status(days=7)
              print(f'\n{status["commander_message"]}')
              
              sys.exit(0)
              
          except Exception as e:
              print(f'âš ï¸ Error registering RL result: {e}', file=sys.stderr)
              import traceback
              traceback.print_exc()
              print('Continuing without reward registration...')
              sys.exit(0)  # Don't fail the workflow if RL fails
          PYCODE
          EXIT_CODE=${PIPESTATUS[0]}
          set -e
          
          # Mostrar resultado
          cat /tmp/rl_result.log >> $GITHUB_STEP_SUMMARY
          
          # NÃ£o falhar o workflow se RL falhar
          exit 0

  # ==================================================
  # RESUMO: Status final
  # ==================================================
  summary:
    name: "ðŸ“‹ Resumo da Auto-EvoluÃ§Ã£o"
    needs: [check_trigger_conditions, consolidate_knowledge, find_next_mission, attempt_evolution, log_evolution_result]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“‹ Gerar resumo
        run: |
          echo "==================================================" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“‹ RESUMO DO CICLO DE AUTO-EVOLUÃ‡ÃƒO" >> $GITHUB_STEP_SUMMARY
          echo "==================================================" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "**Trigger:** Push para main - ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Origem do Merge:** ${{ needs.check_trigger_conditions.outputs.merge_source }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deve Evoluir:** ${{ needs.check_trigger_conditions.outputs.should_evolve }}" >> $GITHUB_STEP_SUMMARY
          echo "**MissÃ£o Encontrada:** ${{ needs.find_next_mission.outputs.has_mission || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
          echo "**EvoluÃ§Ã£o Bem-Sucedida:** ${{ needs.attempt_evolution.outputs.evolution_success || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PrincÃ­pios da Auto-EvoluÃ§Ã£o:**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Toda evoluÃ§Ã£o Ã© triggada por push para main" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Detecta origem do merge (auto-evoluÃ§Ã£o vs externa)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Consolida conhecimento em merges de auto-evoluÃ§Ã£o" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… MissÃµes priorizadas por seÃ§Ã£o do ROADMAP" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Reinforcement Learning integrado (rewards/punishments)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Comandante pode revisar todas as PRs de evoluÃ§Ã£o" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "_Sistema de Auto-EvoluÃ§Ã£o do Jarvis com Reinforcement Learning_" >> $GITHUB_STEP_SUMMARY
