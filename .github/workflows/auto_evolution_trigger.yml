name: Auto Evolution Trigger

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  # ==================================================
  # 1. ORQUESTRAÃ‡ÃƒO: Decide se Marca ou se Evolui
  # ==================================================
  process_evolution:
    name: "ðŸ§¬ Orquestrador por Capability"
    runs-on: ubuntu-latest
    outputs:
      should_evolve: ${{ steps.decide.outputs.should_evolve }}
      capability_id: ${{ steps.decide.outputs.capability_id }}
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ðŸ“¦ Instalar DependÃªncias
        run: pip install pydantic sqlmodel requests

      - name: ðŸ§  DecisÃ£o por Capability
        id: decide
        run: |
          export PYTHONPATH="${PYTHONPATH:+$PYTHONPATH:}$(pwd)"
          python - << 'PYCODE'
          import os, re, subprocess
          from app.application.services.auto_evolution import AutoEvolutionService

          auto = AutoEvolutionService()

          commit_msg = subprocess.check_output(
              ["git", "log", "-1", "--pretty=%B"],
              text=True
          )

          is_auto_evolution = "[Auto-Evolution]" in commit_msg

          if is_auto_evolution:
              # extrai capability_id do commit ou PR body
              match = re.search(r"capability_id\s*:\s*(\d+)", commit_msg)
              if not match:
                  raise RuntimeError("capability_id nÃ£o encontrado no commit de auto-evoluÃ§Ã£o")

              capability_id = int(match.group(1))

              auto.mark_capability_completed(
                  capability_id=capability_id,
                  implementation_logic=commit_msg.strip()
              )

              subprocess.run(["git", "config", "--global", "user.name", "Jarvis-AutoEvolution"])
              subprocess.run(["git", "config", "--global", "user.email", "jarvis@bot.com"])
              subprocess.run(["git", "add", "docs/capabilities/capability.json"])
              subprocess.run(["git", "commit", "-m", "[Auto-Evolution] Capability synchronized âœ…"], check=False)
              subprocess.run(["git", "push", "origin", "main"])

              with open(os.environ["GITHUB_OUTPUT"], "a") as f:
                  f.write("should_evolve=false\n")
                  f.write(f"capability_id={capability_id}\n")

          else:
              next_cap = auto.find_next_capability()
              if not next_cap:
                  with open(os.environ["GITHUB_OUTPUT"], "a") as f:
                      f.write("should_evolve=false\n")
              else:
                  with open(os.environ["GITHUB_OUTPUT"], "a") as f:
                      f.write("should_evolve=true\n")
                      f.write(f"capability_id={next_cap['id']}\n")
          PYCODE

# ==================================================
  # 2. ANÃLISE: SeleÃ§Ã£o por Capability + Risco
  # ==================================================
  find_and_analyze:
    name: "ðŸŽ¯ SeleÃ§Ã£o e AnÃ¡lise por Capability"
    needs: process_evolution
    if: needs.process_evolution.outputs.should_evolve == 'true'
    runs-on: ubuntu-latest
    outputs:
      has_mission: ${{ steps.select.outputs.has_mission }}
      capability_id: ${{ steps.select.outputs.capability_id }}
      capability_name: ${{ steps.select.outputs.capability_name }}
      requires_human: ${{ steps.analyzer.outputs.requires_human }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ðŸ“¦ Instalar DependÃªncias
        run: pip install pydantic sqlmodel requests

      - name: ðŸŽ¯ SeleÃ§Ã£o de Capability
        id: select
        run: |
          export PYTHONPATH="${PYTHONPATH:+$PYTHONPATH:}$(pwd)"
          python - << 'PYCODE'
          import os
          from app.application.services.auto_evolution import AutoEvolutionService

          auto = AutoEvolutionService()
          cap = auto.find_next_capability()

          if not cap:
              with open(os.environ["GITHUB_OUTPUT"], "a") as f:
                  f.write("has_mission=false\n")
          else:
              with open(os.environ["GITHUB_OUTPUT"], "a") as f:
                  f.write("has_mission=true\n")
                  f.write(f"capability_id={cap['id']}\n")
                  f.write(f"capability_name={cap['capability_name']}\n")

              with open("capability_context.txt", "w") as ctx:
                  ctx.write(f"CAPABILITY ID: {cap['id']}\n")
                  ctx.write(f"NAME: {cap['capability_name']}\n")
                  ctx.write(f"CHAPTER: {cap['chapter']}\n")
                  ctx.write(f"CURRENT STATUS: {cap['status']}\n")
          PYCODE

      - name: ðŸ”¬ MecÃ¢nico Revisionador (AnÃ¡lise de Risco)
        if: steps.select.outputs.has_mission == 'true'
        id: analyzer
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: |
          python scripts/metabolism_analyzer.py \
            --intent "auto-evolution" \
            --instruction "Implement capability: ${{ steps.select.outputs.capability_name }}" \
            --context "$(cat capability_context.txt)" \
            --repo-path "."

      - name: Upload Context
        if: steps.select.outputs.has_mission == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: capability-context
          path: |
            capability_context.txt
            .github/metabolism_logs/
# ==================================================
  # 3. EVOLUÃ‡ÃƒO: MutaÃ§Ã£o baseada em Capability
  # ==================================================
  attempt_evolution:
    name: "ðŸ§¬ Executar MutaÃ§Ã£o por Capability"
    needs: find_and_analyze
    if: |
      needs.find_and_analyze.outputs.has_mission == 'true' &&
      needs.find_and_analyze.outputs.requires_human == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Context
        uses: actions/download-artifact@v4
        with:
          name: capability-context

      - name: Setup Env
        run: |
          git config --global user.name "Jarvis-AutoEvolution"
          git config --global user.email "jarvis@bot.com"
          pip install requests pydantic sqlmodel

      - name: ðŸ¤– MutaÃ§Ã£o de DNA por Capability
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CAPABILITY_ID: ${{ needs.find_and_analyze.outputs.capability_id }}
          CAPABILITY_NAME: ${{ needs.find_and_analyze.outputs.capability_name }}
        run: |
          BRANCH_NAME="auto-evolution/capability-${CAPABILITY_ID}-$(date +%s)"
          git checkout -b "$BRANCH_NAME"

          export PYTHONPATH="${PYTHONPATH:+$PYTHONPATH:}$(pwd)"

          python scripts/metabolism_mutator.py \
            --intent "auto-evolution-capability" \
            --strategy "minimal_change" \
            --capability-id "$CAPABILITY_ID" \
            --capability-name "$CAPABILITY_NAME" \
            --context "$(cat capability_context.txt)"

          # --- FILTRO DE DNA ---
          git add -A
          git reset .github/metabolism_logs/ || true

          if [ -z "$(git status --porcelain)" ]; then
            echo "âš ï¸ Nenhuma mudanÃ§a real detectada. Abortando."
            exit 0
          fi

          git commit -m "[Auto-Evolution] Implement capability_id: ${CAPABILITY_ID}
          
capability_id: ${CAPABILITY_ID}
capability_name: ${CAPABILITY_NAME}"

          git push origin "$BRANCH_NAME"

          gh pr create \
            --title "ðŸ§¬ Capability ${CAPABILITY_ID}: ${CAPABILITY_NAME}" \
            --body "Implements capability_id: ${CAPABILITY_ID}

capability_name: ${CAPABILITY_NAME}

--- 
Gerado automaticamente pelo JARVIS." \
            --base main \
            --head "$BRANCH_NAME"