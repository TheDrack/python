name: Auto Evolution Trigger

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  # ==================================================
  # 1. VERIFICA√á√ÉO: Mant√©m a distin√ß√£o para evitar loop
  # ==================================================
  check_trigger_conditions:
    name: "üîç Verificar Condi√ß√µes de Trigger"
    runs-on: ubuntu-latest
    outputs:
      should_evolve: ${{ steps.check.outputs.should_evolve }}
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üß¨ Validar Origem
        id: check
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          # Se o commit for do JARVIS, n√£o trigga evolu√ß√£o (apenas consolida√ß√£o abaixo)
          if [[ "$COMMIT_MSG" == *"[Auto-Evolution]"* ]] || [[ "${{ github.event.head_commit.author.name }}" == "Jarvis-AutoEvolution" ]]; then
            echo "should_evolve=false" >> "$GITHUB_OUTPUT"
          else
            echo "should_evolve=true" >> "$GITHUB_OUTPUT"
          fi

  # ==================================================
  # 2. AN√ÅLISE: Busca miss√£o e prepara o contexto do RL
  # ==================================================
  find_next_mission:
    name: "üéØ Buscar Pr√≥xima Miss√£o"
    needs: check_trigger_conditions
    if: needs.check_trigger_conditions.outputs.should_evolve == 'true'
    runs-on: ubuntu-latest
    outputs:
      has_mission: ${{ steps.find.outputs.has_mission }}
      mission_description: ${{ steps.find.outputs.mission_description }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Instalar depend√™ncias
        run: pip install -r requirements.txt || echo "..."

      - name: üéØ Sele√ß√£o de Miss√£o via Auto-Evolution Service
        id: find
        run: |
          export PYTHONPATH="${PYTHONPATH:+$PYTHONPATH:}$(pwd)"
          python - << 'PYCODE'
          import os, sys
          try:
              from app.application.services.auto_evolution import AutoEvolutionService
              auto = AutoEvolutionService()
              next_mission = auto.find_next_mission_with_auto_complete()
              
              if next_mission:
                  m_data = next_mission['mission']
                  # Grava para o GitHub Actions ler
                  with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                      f.write('has_mission=true\n')
                      f.write(f'mission_description={m_data["description"].replace(chr(10), " ")}\n')
                  # Preserva o contexto completo para o RL
                  with open('mission_context.txt', 'w') as f:
                      f.write(auto.get_roadmap_context(next_mission))
              else:
                  with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                      f.write('has_mission=false\n')
          except Exception as e:
              print(f"Erro na busca: {e}")
              sys.exit(1)
          PYCODE
      
      - name: Upload mission context
        if: steps.find.outputs.has_mission == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: mission-context
          path: mission_context.txt

  # ==================================================
  # 3. EVOLU√á√ÉO AUT√îNOMA: Muta√ß√£o + Testes + Rewards
  # ==================================================
  attempt_evolution:
    name: "üß¨ Tentar Evolu√ß√£o Aut√¥noma"
    needs: [check_trigger_conditions, find_next_mission]
    if: |
      always() && 
      needs.find_next_mission.result == 'success' && 
      needs.find_next_mission.outputs.has_mission == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
        with:
          token: ${{ github.token }}
      
      - name: Download context
        uses: actions/download-artifact@v4
        with:
          name: mission-context

      - name: Configurar Ambiente de Muta√ß√£o
        run: |
          git config --global user.name "Jarvis-AutoEvolution"
          git config --global user.email "jarvis@bot.com"
          # Adicionamos pytest-asyncio para suportar as fun√ß√µes async da LLM
          pip install pytest pytest-json-report pytest-cov pytest-asyncio requests
          pip install -r requirements.txt || echo "Aviso: Depend√™ncias parciais."

      - name: ü§ñ Executar Ciclo de Reinforcement Learning
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          # Esta √© a chave mestra que faltava para o 'gh pr create'
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }} 
          ISSUE_BODY: ${{ needs.find_next_mission.outputs.mission_description }}
          AUTO_EVOLUTION_MODE: "true"
        run: |
          BRANCH_NAME="auto-evolution/mission-$(date +%s)"
          git checkout -b "$BRANCH_NAME"
          export PYTHONPATH="${PYTHONPATH:+$PYTHONPATH:}$(pwd)"
          
          # 2. Muta√ß√£o com Modelo Est√°vel
          # Certifique-se de que o python scripts/metabolism_mutator.py use o modelo correto
          python scripts/metabolism_mutator.py \
            --strategy "minimal_change" \
            --intent "auto-evolution-mission" \
            --impact "functional-improvement" \
            --roadmap-context "$(cat mission_context.txt)"
          
          # 3. For√ßar reconhecimento das mudan√ßas
          git add -A 

          if [ -z "$(git status --porcelain)" ]; then
             echo "‚ö†Ô∏è Sem mudan√ßas. Encerrando."
             exit 0
          fi

          # 4. Feedback do Ambiente (Testes)
          echo "üß™ Iniciando Testes de Valida√ß√£o com Isolamento Total..."
          
          if (unset GROQ_API_KEY OPENAI_API_KEY GEMINI_API_KEY && pytest --json-report --json-report-file=test_report.json); then
            echo "‚úÖ Sucesso! DNA Saud√°vel. Consolidando Evolu√ß√£o..."
            
            # Removemos o test_report.json do commit para n√£o sujar o hist√≥rico
            git add -A
            git reset test_report.json 2>/dev/null || true
            
            git commit -m "[Auto-Evolution] Mission Accomplished - RL Reward Positive"
            git push origin "$BRANCH_NAME"

            # ABERTURA AUTOM√ÅTICA DE PR
            echo "pull-request: Criando PR para a miss√£o..."
            gh pr create --title "üß¨ Evolu√ß√£o: Mission Accomplished ($BRANCH_NAME)" \
                         --body "O JARVIS completou a miss√£o com sucesso. DNA validado por 619+ testes." \
                         --base main --head "$BRANCH_NAME"
          else
            echo "‚ùå Falha nos testes! O novo DNA √© inst√°vel."
            exit 1
          fi

      # Guardamos o relat√≥rio como um artefato oficial do GitHub (limpo e acess√≠vel)
      - name: Arquivar Relat√≥rio de Testes
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-report-${{ github.run_id }}
          path: test_report.json
