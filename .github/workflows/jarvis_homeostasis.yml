name: "üß¨ JARVIS: Homeostase e Auto-Cura"

on:
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  homeostasis:
    name: "üß™ Vistoria e Auto-Cura"
    runs-on: ubuntu-latest
    steps:
      - name: üõ∞Ô∏è Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: üì¶ Setup Environment
        uses: astral-sh/setup-uv@v5

      - name: üîß Instalar Depend√™ncias
        run: |
          uv venv
          uv pip install pytest pytest-json-report requests sqlmodel pydantic groq
          echo "PYTHONPATH=$PYTHONPATH:$(pwd)" >> $GITHUB_ENV

      - name: üß™ Testes (Tentativa 1)
        id: test_1
        continue-on-error: true
        run: uv run pytest --json-report --json-report-file=report_1.json tests/

      - name: ü©π Auto-Cura (Retry 1)
        if: steps.test_1.outcome == 'failure'
        id: heal_1
        continue-on-error: true
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: |
          uv run python scripts/metabolism_mutator.py --strategy "minimal_change" --intent "fix-test-failure"
          uv run pytest --json-report --json-report-file=report_2.json tests/

      - name: ü©π Auto-Cura (Retry 2)
        if: steps.heal_1.outcome == 'failure'
        id: heal_2
        continue-on-error: true
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: |
          uv run python scripts/metabolism_mutator.py --strategy "minimal_change" --intent "fix-test-failure"
          uv run pytest --json-report --json-report-file=report_3.json tests/

      - name: üî¨ An√°lise de Risco
        id: risk_check
        run: |
          uv run python scripts/metabolism_analyzer.py --intent "auto-evolution" --repo-path "." > analysis_result.txt
          if grep -q '"requires_human": true' analysis_result.txt; then
            echo "HIGH_RISK=true" >> $GITHUB_ENV
          else
            echo "HIGH_RISK=false" >> $GITHUB_ENV
          fi

      - name: ‚úÖ Auto-Merge
        if: (steps.test_1.outcome == 'success' || steps.heal_1.outcome == 'success' || steps.heal_2.outcome == 'success')
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          COMMANDER: "TheDrack"
        run: |
          if [ "$PR_AUTHOR" = "$COMMANDER" ] || [ "${{ env.HIGH_RISK }}" = "false" ]; then
            gh pr merge ${{ github.event.pull_request.number }} --auto --merge
          else
            echo "‚ö†Ô∏è Risco alto ou falha persistente. Revis√£o manual necess√°ria."
            exit 1
          fi
