name: "üß¨ JARVIS: Homeostase e Auto-Cura"

on:
  push:
    branches: [ main ]
  pull_request_target:
    branches: [ main ]
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: write

jobs:
  homeostasis:
    name: "üß™ Vistoria e Auto-Cura"
    runs-on: ubuntu-latest
    
    steps:
      # 1. PREPARA√á√ÉO DO TERRENO
      - name: üõ∞Ô∏è Checkout (SHA da PR ou Main)
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          fetch-depth: 0

      - name: üì¶ Setup Environment (UV)
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: üîß Instalar Depend√™ncias do Sistema
        run: |
          uv venv --python 3.13
          uv pip install pytest pytest-json-report pytest-cov requests sqlmodel pydantic groq
          export PYTHONPATH=$PYTHONPATH:$(pwd)

      # 2. O JUIZ: EXECU√á√ÉO √öNICA DOS TESTES
      - name: üß™ Executar Pytest
        id: run_tests
        continue-on-error: true
        run: |
          export PYTHONPATH=$PYTHONPATH:$(pwd)
          uv run pytest --json-report --json-report-file=report_1.json tests/

      # 3. CAMINHO A: SUCESSO (Homeostase Mantida)
      - name: ‚úÖ Auto-Merge
        if: steps.run_tests.outcome == 'success' && github.event_name == 'pull_request_target'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr merge "${{ github.event.pull_request.number }}" --auto --merge --repo "${{ github.repository }}"
          gh pr comment "${{ github.event.pull_request.number }}" --body "## ‚úÖ Homeostase Mantida. DNA validado."

      # 4. CAMINHO B: FALHA (In√≠cio do Ciclo de Auto-Cura)
      - name: üîß Ciclo de Cura 1 (Proposta e An√°lise)
        if: steps.run_tests.outcome == 'failure'
        id: heal_step_1
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          GH_TOKEN: ${{ github.token }}
        run: |
          export PYTHONPATH=$PYTHONPATH:$(pwd)
          # A IA prop√µe a corre√ß√£o baseada no report_1.json
          python scripts/self_healing_mutator.py --report "report_1.json"
          
          # üî¨ O MEC√ÇNICO REVISIONADOR entra em cena
          python scripts/metabolism_analyzer.py --intent "auto-fix" --repo-path "." > analysis_1.txt
          
          if grep -q "REQUIRES_HUMAN: true" analysis_1.txt; then
            echo "stop_healing=true" >> $GITHUB_ENV
          else
            git config --global user.name "Jarvis-AutoCura"
            git config --global user.email "jarvis@bot.com"
            git add .
            git commit -m "ü§ñ [Auto-Cura] Tentativa 1: Corrigindo falhas detectadas"
            git push origin HEAD:${{ github.event.pull_request.head.ref }}
            # Re-testar
            uv run pytest --json-report --json-report-file=report_2.json tests/ || echo "still_failing=true" >> $GITHUB_ENV
          fi

      - name: üîß Ciclo de Cura 2 (√öltima Tentativa)
        if: env.still_failing == 'true' && env.stop_healing != 'true'
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: |
          export PYTHONPATH=$PYTHONPATH:$(pwd)
          python scripts/self_healing_mutator.py --report "report_2.json"
          
          # Nova vistoria do Mec√¢nico
          python scripts/metabolism_analyzer.py --intent "auto-fix" --repo-path "." > analysis_2.txt
          
          if ! grep -q "REQUIRES_HUMAN: true" analysis_2.txt; then
            git add .
            git commit -m "ü§ñ [Auto-Cura] Tentativa 2: Ajuste final"
            git push origin HEAD:${{ github.event.pull_request.head.ref }}
            uv run pytest tests/ || echo "final_failure=true" >> $GITHUB_ENV
          else
            echo "final_failure=true" >> $GITHUB_ENV
          fi

      # 5. ESCALONAMENTO (Interven√ß√£o Humana)
      - name: üö® Escalonar ao Comandante
        if: env.final_failure == 'true' || env.stop_healing == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr edit "${{ github.event.pull_request.number }}" --add-label "commander-review"
          gh pr comment "${{ github.event.pull_request.number }}" --body "## üö® COMANDANTE: Interven√ß√£o Necess√°ria
          O metabolismo falhou na auto-cura ou o **Mec√¢nico Revisionador** detectou alto risco.
          
          **Status:** Escalonado para revis√£o manual.
          ---
          _Por favor, aplique as corre√ß√µes necess√°rias para restaurar a homeostase._"
          
          gh issue create --title "üî¥ Falha na Auto-Cura: PR #${{ github.event.pull_request.number }}" \
                          --body "O JARVIS tentou se curar mas os limites de seguran√ßa foram atingidos. Verifique a PR #${{ github.event.pull_request.number }}." \
                          --label "commander-review, bug"
