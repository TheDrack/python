name: "üß¨ JARVIS: Homeostase e Auto-Cura"

on:
  push:
    branches: [ main ]
  pull_request_target:
    branches: [ main ]
    types: [opened, synchronize, reopened]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: write

jobs:
  homeostasis:
    name: "üß™ Vistoria e Auto-Cura"
    if: (github.event_name == 'pull_request_target') || (github.event_name == 'push' && !contains(github.event.head_commit.message, 'ü§ñ [Auto-Cura]'))
    runs-on: ubuntu-latest

    steps:
      - name: üõ∞Ô∏è Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}
          repository: ${{ github.event.pull_request.head.repo.full_name || github.repository }}
          fetch-depth: 0

      - name: üì¶ Setup Environment (UV)
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: üîß Instalar Depend√™ncias
        run: |
          uv venv --python 3.13
          uv pip install pytest pytest-json-report pytest-cov requests sqlmodel pydantic groq python-jose[cryptography] bcrypt
          echo "PYTHONPATH=$PYTHONPATH:$(pwd)" >> $GITHUB_ENV

      - name: üß™ Executar Pytest
        id: run_tests
        continue-on-error: true
        run: |
          uv run pytest --json-report --json-report-file=report_1.json tests/

      - name: üî¨ An√°lise de Risco (Mec√¢nico)
        id: risk_check
        run: |
          uv run python scripts/metabolism_analyzer.py --intent "auto-evolution" --instruction "Validar autonomia" --repo-path "." > analysis_result.txt
          if grep -q '"requires_human": true' analysis_result.txt; then
            echo "HIGH_RISK=true" >> $GITHUB_ENV
          else
            echo "HIGH_RISK=false" >> $GITHUB_ENV
          fi

      - name: ‚úÖ Auto-Merge (Protocolo Voz do Dono)
        # S√≥ executa se os testes passaram e √© uma Pull Request
        if: steps.run_tests.outcome == 'success' && github.event.pull_request.number != null
        env:
          GH_TOKEN: ${{ github.token }}
          # Mapeamento expl√≠cito para o Bash n√£o se perder
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          COMMANDER: "TheDrack"
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          echo "üî¨ Analisando autor da PR: $PR_AUTHOR"
          
          # Se o autor for voc√™ OU se o Mec√¢nico deu sinal verde (HIGH_RISK=false)
          if [ "$PR_AUTHOR" == "$COMMANDER" ] || [ "${{ env.HIGH_RISK }}" == "false" ]; then
            echo "ü´° Condi√ß√µes de seguran√ßa atingidas (Autor: $PR_AUTHOR / Risco: ${{ env.HIGH_RISK }})."
            echo "üöÄ Executando Merge..."
            gh pr merge "$PR_NUMBER" --auto --merge --repo "${{ github.repository }}"
          else
            echo "‚ö†Ô∏è Merge bloqueado: DNA Sens√≠vel detectado em PR de terceiro/IA. Aguardando Comandante."
            exit 0
          fi
