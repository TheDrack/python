name: JARVIS Crystallizer

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'data/capabilities.json'
      - 'app/domain/**'

jobs:
  organize:
    name: "ğŸ’ Ciclo de CristalizaÃ§Ã£o DNA"
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ›°ï¸ Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.JARVIS_PAT || secrets.GITHUB_TOKEN }}

      - name: ğŸ“¦ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ğŸ§  Run Crystallizer Engine (Full Cycle)
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          # Instalando dependÃªncias mÃ­nimas para o motor rodar
          pip install requests sqlmodel pydantic
          
          # Executando o motor exatamente como no orquestrador
          python - << 'PYCODE'
          import sys
          from app.application.services.crystallization.crystallizer_engine import CrystallizerEngine
          
          try:
              print("ğŸ’ Iniciando Full Cycle do Crystallizer Engine...")
              engine = CrystallizerEngine()
              engine.run_full_cycle()
              print("âœ¨ CristalizaÃ§Ã£o concluÃ­da com sucesso.")
          except Exception as e:
              print(f"âŒ Erro crÃ­tico na cristalizaÃ§Ã£o: {e}")
              sys.exit(1)
          PYCODE
          
      - name: ğŸ”„ Sync DNA Map & Containers
        run: |
          git config --global user.name "Jarvis-Crystallizer"
          git config --global user.email "jarvis@bot.com"
          
          # Adiciona o Master Crystal e os Containers gerados/atualizados
          git add data/master_crystal.json app/application/containers/*.py
          
          # Realiza o commit apenas se houver mudanÃ§as detectadas no ciclo
          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "chore: [Crystallizer] DNA Mapping & Container Synchronization"
            git push origin main
          else
            echo "âœ… DNA jÃ¡ estÃ¡ sincronizado e estÃ¡vel."
          fi
