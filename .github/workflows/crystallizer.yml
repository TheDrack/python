name: "ğŸ’ JARVIS: Crystallizer"

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'data/capabilities.json'
      - 'app/domain/**'
      - 'app/application/services/**'

jobs:
  organize:
    name: "ğŸ’ Ciclo de CristalizaÃ§Ã£o DNA"
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ›°ï¸ Checkout
        uses: actions/checkout@v4
        with:
          # Alterado para GIT_PAT para garantir que o push tenha forÃ§a total
          token: ${{ secrets.GIT_PAT }}

      - name: ğŸ“¦ Setup UV
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          python-version: '3.11'

      - name: ğŸ§  Run Crystallizer Engine (Full Cycle)
        env:
          PYTHONPATH: ${{ github.workspace }}
          # Caso seu motor precise consultar algo externo (opcional)
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: |
          # Usando UV para velocidade e consistÃªncia com o resto do sistema
          uv venv --clear --python 3.11
          uv pip install requests sqlmodel pydantic python-dotenv
          
          # Executando via uv run para garantir o ambiente virtual
          uv run python - << 'PYCODE'
          import sys
          import os
          from app.application.services.crystallization.crystallizer_engine import CrystallizerEngine
          
          try:
              print("ğŸ’ Iniciando Full Cycle do Crystallizer Engine...")
              engine = CrystallizerEngine()
              engine.run_full_cycle()
              print("âœ¨ CristalizaÃ§Ã£o concluÃ­da com sucesso.")
          except Exception as e:
              print(f"âŒ Erro crÃ­tico na cristalizaÃ§Ã£o: {e}")
              sys.exit(1)
          PYCODE
          
      - name: ğŸ”„ Sync DNA Map & Containers
        env:
          TOKEN: ${{ secrets.GIT_PAT }}
        run: |
          git config --global user.name "Jarvis-Crystallizer"
          git config --global user.email "jarvis@bot.com"
          
          # Reconfigura URL para evitar erro 403 (Permission Denied)
          git remote set-url origin https://x-access-token:${TOKEN}@github.com/${{ github.repository }}.git
          
          # Garante que estamos na main e sincronizados
          git checkout main || git checkout -b main
          git pull origin main --rebase
          
          # Adiciona o Master Crystal e os Containers gerados/atualizados
          git add data/master_crystal.json app/application/containers/*.py
          
          # Realiza o commit apenas se houver mudanÃ§as detectadas
          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "chore: [Crystallizer] DNA Mapping & Container Synchronization [Auto-Cura]"
            git push origin main
          else
            echo "âœ… DNA jÃ¡ estÃ¡ sincronizado e estÃ¡vel."
          fi
