name: Jarvis Metabolism Flow

# ==================================================
# FLUXO DE METABOLISMO DO JARVIS
# ==================================================
#
# O Jarvis Ã© tratado como um organismo de software.
# Seu repositÃ³rio representa seu DNA.
# Qualquer alteraÃ§Ã£o nesse DNA deve passar por um
# processo metabÃ³lico controlado, rastreÃ¡vel e validado.
#
# Este fluxo Ã© acionado sempre que houver qualquer
# evento que impacte o DNA do Jarvis.
#
# Estrutura:
# 1. EVENTO DE ENTRADA - Qualquer evento que demande aÃ§Ã£o sobre o DNA
# 2. MECÃ‚NICO REVISIONADOR - AnÃ¡lise metabÃ³lica da intenÃ§Ã£o
# 3. CRITÃ‰RIO DE ESCALONAMENTO - DecisÃ£o: automatizar ou escalar
# 4. OFICINA - ExecuÃ§Ã£o metabÃ³lica em branch isolada
# 5. MECÃ‚NICO CONSERTADOR - ImplementaÃ§Ã£o da mutaÃ§Ã£o
# 6. VISTORIA - ValidaÃ§Ã£o homeostÃ¡tica (pytest)
# 7. CONTROLE DE LOOP - MÃ¡ximo 3 ciclos completos
# 8. COMANDANTE - ConsciÃªncia superior (humano)
# 9. PRINCÃPIOS FUNDAMENTAIS - DNA sagrado, testes = imunolÃ³gico
#
# ==================================================

on:
  # 1. EVENTO DE ENTRADA - MÃºltiplas fontes de intenÃ§Ã£o tÃ©cnica
  pull_request:
    types: [opened, synchronize, reopened]
  issues:
    types: [opened, edited]
  repository_dispatch:
    types: [jarvis_order, auto_fix, metabolism_event]
  workflow_dispatch:
    inputs:
      intent:
        description: 'IntenÃ§Ã£o tÃ©cnica (correÃ§Ã£o/criaÃ§Ã£o/modificaÃ§Ã£o/otimizaÃ§Ã£o/operacional)'
        required: true
        type: string
      instruction:
        description: 'DescriÃ§Ã£o detalhada da aÃ§Ã£o necessÃ¡ria'
        required: true
        type: string
      context:
        description: 'Contexto adicional (opcional)'
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  # ==================================================
  # 2. MECÃ‚NICO REVISIONADOR - AnÃ¡lise MetabÃ³lica
  # ==================================================
  metabolic_analysis:
    name: "ðŸ” MecÃ¢nico Revisionador - AnÃ¡lise MetabÃ³lica"
    runs-on: ubuntu-latest
    # Ativa para eventos relevantes ao DNA
    if: |
      github.event_name == 'pull_request' ||
      contains(github.event.issue.labels.*.name, 'auto-code') ||
      contains(github.event.issue.labels.*.name, 'jarvis-auto-report') ||
      contains(github.event.issue.labels.*.name, 'metabolism') ||
      github.event_name == 'repository_dispatch' ||
      github.event_name == 'workflow_dispatch'
    outputs:
      requires_human: ${{ steps.analyze.outputs.requires_human }}
      intent_type: ${{ steps.analyze.outputs.intent_type }}
      impact_type: ${{ steps.analyze.outputs.impact_type }}
      mutation_strategy: ${{ steps.analyze.outputs.mutation_strategy }}
      escalation_reason: ${{ steps.analyze.outputs.escalation_reason }}
      event_description: ${{ steps.analyze.outputs.event_description }}
      
    steps:
      - name: Checkout DNA (RepositÃ³rio)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-json-report pytest-cov
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt || echo "Some dependencies failed, continuing..."
          fi

      - name: ðŸ“‹ Capturar Evento de Entrada
        id: capture_event
        run: |
          echo "==================================================" >> $GITHUB_STEP_SUMMARY
          echo "## 1ï¸âƒ£ EVENTO DE ENTRADA - O METABOLISMO COMEÃ‡A" >> $GITHUB_STEP_SUMMARY
          echo "==================================================" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Detectar tipo de evento e extrair informaÃ§Ãµes
          if [[ "${{ github.event_name }}" == "repository_dispatch" ]]; then
            INTENT="${{ github.event.client_payload.intent }}"
            INSTRUCTION="${{ github.event.client_payload.instruction }}"
            CONTEXT="${{ github.event.client_payload.context }}"
            EVENT_DESC="API Request: $INTENT - $INSTRUCTION"
            
            echo "**Tipo de Evento:** repository_dispatch (API)" >> $GITHUB_STEP_SUMMARY
            echo "**IntenÃ§Ã£o:** $INTENT" >> $GITHUB_STEP_SUMMARY
            echo "**InstruÃ§Ã£o:** $INSTRUCTION" >> $GITHUB_STEP_SUMMARY
            
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            INTENT="${{ github.event.inputs.intent }}"
            INSTRUCTION="${{ github.event.inputs.instruction }}"
            CONTEXT="${{ github.event.inputs.context }}"
            EVENT_DESC="Manual Trigger: $INTENT - $INSTRUCTION"
            
            echo "**Tipo de Evento:** workflow_dispatch (Manual)" >> $GITHUB_STEP_SUMMARY
            echo "**IntenÃ§Ã£o:** $INTENT" >> $GITHUB_STEP_SUMMARY
            echo "**InstruÃ§Ã£o:** $INSTRUCTION" >> $GITHUB_STEP_SUMMARY
            
          elif [[ "${{ github.event_name }}" == "issues" ]]; then
            INTENT="correÃ§Ã£o"
            INSTRUCTION="${{ github.event.issue.title }}"
            CONTEXT="${{ github.event.issue.body }}"
            EVENT_DESC="Issue #${{ github.event.issue.number }}: $INSTRUCTION"
            
            echo "**Tipo de Evento:** Issue #${{ github.event.issue.number }}" >> $GITHUB_STEP_SUMMARY
            echo "**TÃ­tulo:** $INSTRUCTION" >> $GITHUB_STEP_SUMMARY
            
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            INTENT="validaÃ§Ã£o"
            INSTRUCTION="PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}"
            CONTEXT="Validar mudanÃ§as propostas no DNA"
            EVENT_DESC="PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}"
            
            echo "**Tipo de Evento:** Pull Request #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
            echo "**TÃ­tulo:** ${{ github.event.pull_request.title }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "INTENT=$INTENT" >> $GITHUB_ENV
          echo "INSTRUCTION=$INSTRUCTION" >> $GITHUB_ENV
          echo "CONTEXT=$CONTEXT" >> $GITHUB_ENV
          echo "EVENT_DESC=$EVENT_DESC" >> $GITHUB_ENV
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**âœ… Evento capturado e classificado como intenÃ§Ã£o tÃ©cnica sobre o DNA**" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ”¬ AnÃ¡lise MetabÃ³lica - InterpretaÃ§Ã£o da IntenÃ§Ã£o
        id: analyze
        env:
          GITHUB_TOKEN: ${{ secrets.JARVIS_TOKEN_CI || github.token }}
          GH_TOKEN: ${{ secrets.JARVIS_TOKEN_CI || github.token }}
        run: |
          echo "==================================================" >> $GITHUB_STEP_SUMMARY
          echo "## 2ï¸âƒ£ MECÃ‚NICO REVISIONADOR - AnÃ¡lise MetabÃ³lica" >> $GITHUB_STEP_SUMMARY
          echo "==================================================" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Executar script de anÃ¡lise metabÃ³lica com melhor tratamento de erros
          set +e  # NÃ£o parar em erros para capturar saÃ­da
          OUTPUT=$(python scripts/metabolism_analyzer.py \
            --intent "$INTENT" \
            --instruction "$INSTRUCTION" \
            --context "$CONTEXT" \
            --event-type "${{ github.event_name }}" 2>&1)
          EXIT_CODE=$?
          set -e
          
          # Mostrar saÃ­da completa
          echo "$OUTPUT"
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### SaÃ­da do Analisador" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "$OUTPUT" | tail -50 >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          # Verificar se houve erro
          if [ $EXIT_CODE -ne 0 ] && [ $EXIT_CODE -ne 1 ]; then
            echo "**âŒ ERRO na anÃ¡lise metabÃ³lica (cÃ³digo: $EXIT_CODE)**" >> $GITHUB_STEP_SUMMARY
            exit $EXIT_CODE
          fi
          
          # Exit code 1 = requires_human, 0 = prosseguir automÃ¡tico
          exit $EXIT_CODE

      - name: ðŸš¨ CritÃ©rio de Escalonamento Antecipado
        id: escalation_check
        if: steps.analyze.outputs.requires_human == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.JARVIS_TOKEN_CI || github.token }}
          GH_TOKEN: ${{ secrets.JARVIS_TOKEN_CI || github.token }}
        run: |
          echo "==================================================" >> $GITHUB_STEP_SUMMARY
          echo "## 3ï¸âƒ£ ESCALONAMENTO ANTECIPADO AO COMANDANTE" >> $GITHUB_STEP_SUMMARY
          echo "==================================================" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          REASON="${{ steps.analyze.outputs.escalation_reason }}"
          
          echo "**âš ï¸ InterrupÃ§Ã£o do Fluxo AutomÃ¡tico**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Motivo do Escalonamento:**" >> $GITHUB_STEP_SUMMARY
          echo "$REASON" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**AÃ§Ã£o:** Aguardando decisÃ£o do COMANDANTE (humano)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PrincÃ­pio:** Nenhuma alteraÃ§Ã£o no DNA sem compreensÃ£o completa" >> $GITHUB_STEP_SUMMARY
          
          # Criar comentÃ¡rio na issue/PR solicitando intervenÃ§Ã£o humana
          if [[ -n "${{ github.event.issue.number }}" ]]; then
            gh issue comment "${{ github.event.issue.number }}" --body "## ðŸš¨ COMANDANTE: IntervenÃ§Ã£o NecessÃ¡ria

$REASON

O MecÃ¢nico Revisionador determinou que esta mudanÃ§a no DNA requer decisÃ£o humana antes de prosseguir com o metabolismo automÃ¡tico.

**Aguardando sua anÃ¡lise e orientaÃ§Ã£o.**"
          elif [[ -n "${{ github.event.pull_request.number }}" ]]; then
            gh pr comment "${{ github.event.pull_request.number }}" --body "## ðŸš¨ COMANDANTE: IntervenÃ§Ã£o NecessÃ¡ria

$REASON

O MecÃ¢nico Revisionador determinou que esta mudanÃ§a no DNA requer decisÃ£o humana antes de prosseguir com o metabolismo automÃ¡tico.

**Aguardando sua anÃ¡lise e orientaÃ§Ã£o.**"
          fi
          
          exit 0

  # ==================================================
  # 4-5. OFICINA + MECÃ‚NICO CONSERTADOR - MutagÃªnese Controlada
  # ==================================================
  metabolic_mutation:
    name: "ðŸ”§ Oficina + MecÃ¢nico Consertador - MutagÃªnese"
    needs: metabolic_analysis
    if: needs.metabolic_analysis.outputs.requires_human != 'true'
    runs-on: ubuntu-latest
    outputs:
      mutation_applied: ${{ steps.mutate.outputs.mutation_applied }}
      branch_name: ${{ steps.mutate.outputs.branch_name }}
      cycle_count: ${{ steps.mutate.outputs.cycle_count }}
      
    steps:
      - name: Checkout DNA (RepositÃ³rio)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-json-report pytest-cov
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt || echo "Some dependencies failed, continuing..."
          fi

      - name: Install GitHub Copilot CLI
        env:
          GITHUB_TOKEN: ${{ secrets.JARVIS_TOKEN_CI || github.token }}
          GH_TOKEN: ${{ secrets.JARVIS_TOKEN_CI || github.token }}
        run: |
          gh --version
          gh extension install github/gh-copilot || echo "Copilot extension already installed"
          gh auth setup-git

      - name: ðŸ—ï¸ Oficina - Criar Branch Isolada para Metabolismo
        id: workshop
        run: |
          echo "==================================================" >> $GITHUB_STEP_SUMMARY
          echo "## 4ï¸âƒ£ OFICINA - ExecuÃ§Ã£o MetabÃ³lica" >> $GITHUB_STEP_SUMMARY
          echo "==================================================" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Configurar Git
          git config --global user.name "Jarvis-Metabolismo"
          git config --global user.email "jarvis-metabolism@bot.com"
          
          # Criar branch isolada para mutaÃ§Ã£o
          TIMESTAMP=$(date +%s)
          BRANCH_NAME="metabolism/mutation-${TIMESTAMP}"
          git checkout -b "$BRANCH_NAME"
          
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
          echo "**Branch de MutaÃ§Ã£o:** \`$BRANCH_NAME\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PrincÃ­pio:** Toda mutaÃ§Ã£o em ambiente isolado, rastreÃ¡vel e auditÃ¡vel" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ§¬ MecÃ¢nico Consertador - Implementar MutagÃªnese Controlada
        id: mutate
        env:
          GITHUB_TOKEN: ${{ secrets.JARVIS_TOKEN_CI || github.token }}
          GH_TOKEN: ${{ secrets.JARVIS_TOKEN_CI || github.token }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          INTENT_TYPE: ${{ needs.metabolic_analysis.outputs.intent_type }}
          IMPACT_TYPE: ${{ needs.metabolic_analysis.outputs.impact_type }}
          MUTATION_STRATEGY: ${{ needs.metabolic_analysis.outputs.mutation_strategy }}
        run: |
          echo "==================================================" >> $GITHUB_STEP_SUMMARY
          echo "## 5ï¸âƒ£ MECÃ‚NICO CONSERTADOR - MutagÃªnese Controlada" >> $GITHUB_STEP_SUMMARY
          echo "==================================================" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Executar mecÃ¢nico consertador com estratÃ©gia de mutaÃ§Ã£o aprovada
          set +e
          OUTPUT=$(python scripts/metabolism_mutator.py \
            --strategy "$MUTATION_STRATEGY" \
            --intent "$INTENT_TYPE" \
            --impact "$IMPACT_TYPE" 2>&1)
          EXIT_CODE=$?
          set -e
          
          # Mostrar saÃ­da completa
          echo "$OUTPUT"
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### SaÃ­da do Mutador" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "$OUTPUT" | tail -50 >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          # Verificar sucesso
          if [ $EXIT_CODE -ne 0 ]; then
            echo "**âŒ ERRO na mutagÃªnese (cÃ³digo: $EXIT_CODE)**" >> $GITHUB_STEP_SUMMARY
            exit $EXIT_CODE
          fi
          
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**âœ… MutagÃªnese executada com sucesso**" >> $GITHUB_STEP_SUMMARY

  # ==================================================
  # 6. VISTORIA - Homeostase (ValidaÃ§Ã£o com Pytest)
  # ==================================================
  homeostasis_validation:
    name: "ðŸ§ª Vistoria - Homeostase (Sistema ImunolÃ³gico)"
    needs: [metabolic_analysis, metabolic_mutation]
    if: needs.metabolic_mutation.outputs.mutation_applied == 'true'
    runs-on: ubuntu-latest
    outputs:
      homeostasis_ok: ${{ steps.validate.outputs.homeostasis_ok }}
      
    steps:
      - name: Checkout DNA Mutado
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.metabolic_mutation.outputs.branch_name }}
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-json-report pytest-cov
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt || echo "Some dependencies failed, continuing..."
          fi

      - name: ðŸ§ª Vistoria - Executar Sistema ImunolÃ³gico (Pytest)
        id: validate
        continue-on-error: true
        run: |
          echo "==================================================" >> $GITHUB_STEP_SUMMARY
          echo "## 6ï¸âƒ£ VISTORIA - Homeostase (Sistema ImunolÃ³gico)" >> $GITHUB_STEP_SUMMARY
          echo "==================================================" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "**Executando suÃ­te de testes (anticorpos)...**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Executar pytest
          if pytest --json-report --json-report-file=report.json; then
            echo "homeostasis_ok=true" >> $GITHUB_OUTPUT
            echo "**âœ… HOMEOSTASE MANTIDA** - Todos os testes passaram" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "O DNA permanece funcional apÃ³s a mutaÃ§Ã£o." >> $GITHUB_STEP_SUMMARY
          else
            echo "homeostasis_ok=false" >> $GITHUB_OUTPUT
            echo "**âŒ HOMEOSTASE COMPROMETIDA** - Testes falharam" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**AÃ§Ã£o:** Retornar ao MecÃ¢nico Revisionador para nova anÃ¡lise" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Salvar RelatÃ³rio de Vistoria
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: homeostasis-report
          path: report.json

  # ==================================================
  # 7. CONTROLE DE LOOP - Limite MetabÃ³lico (3 Ciclos)
  # ==================================================
  metabolic_loop_control:
    name: "ðŸ” Controle de Loop - Limite MetabÃ³lico"
    needs: [metabolic_analysis, metabolic_mutation, homeostasis_validation]
    if: always() && needs.homeostasis_validation.outputs.homeostasis_ok == 'false'
    runs-on: ubuntu-latest
    
    steps:
      - name: Verificar Limite de Ciclos MetabÃ³licos
        id: check_limit
        run: |
          echo "==================================================" >> $GITHUB_STEP_SUMMARY
          echo "## 7ï¸âƒ£ CONTROLE DE LOOP - Limite MetabÃ³lico" >> $GITHUB_STEP_SUMMARY
          echo "==================================================" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          CURRENT_CYCLE=${{ needs.metabolic_mutation.outputs.cycle_count || 1 }}
          MAX_CYCLES=3
          
          echo "**Ciclo Atual:** $CURRENT_CYCLE de $MAX_CYCLES" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ $CURRENT_CYCLE -ge $MAX_CYCLES ]]; then
            echo "**ðŸš¨ LIMITE METABÃ“LICO ATINGIDO**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ApÃ³s $MAX_CYCLES ciclos completos (AnÃ¡lise â†’ MutaÃ§Ã£o â†’ Vistoria)," >> $GITHUB_STEP_SUMMARY
            echo "o metabolismo automÃ¡tico DEVE cessar." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**AÃ§Ã£o:** Escalar ao COMANDANTE (humano)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Regra CrÃ­tica:** O MecÃ¢nico Revisionador NÃƒO pode tentar uma 4Âª vez" >> $GITHUB_STEP_SUMMARY
            
            echo "limit_reached=true" >> $GITHUB_OUTPUT
          else
            echo "**Tentando novo ciclo metabÃ³lico...**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Ciclo $(($CURRENT_CYCLE + 1)) serÃ¡ iniciado automaticamente" >> $GITHUB_STEP_SUMMARY
            
            echo "limit_reached=false" >> $GITHUB_OUTPUT
          fi

  # ==================================================
  # 8. COMANDANTE - ConsciÃªncia Superior (Humano)
  # ==================================================
  commander_escalation:
    name: "ðŸ‘¤ Comandante - ConsciÃªncia Superior"
    needs: [metabolic_analysis, metabolic_mutation, homeostasis_validation, metabolic_loop_control]
    if: |
      always() && (
        needs.metabolic_analysis.outputs.requires_human == 'true' ||
        needs.metabolic_loop_control.outputs.limit_reached == 'true'
      )
    runs-on: ubuntu-latest
    
    steps:
      - name: Escalar ao Comandante (Humano)
        env:
          GITHUB_TOKEN: ${{ secrets.JARVIS_TOKEN_CI || github.token }}
          GH_TOKEN: ${{ secrets.JARVIS_TOKEN_CI || github.token }}
        run: |
          echo "==================================================" >> $GITHUB_STEP_SUMMARY
          echo "## 8ï¸âƒ£ COMANDANTE - ConsciÃªncia Superior" >> $GITHUB_STEP_SUMMARY
          echo "==================================================" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Preparar relatÃ³rio completo para o comandante
          REPORT="## ðŸŽ¯ RELATÃ“RIO METABÃ“LICO COMPLETO

### Evento Original
**IntenÃ§Ã£o:** ${{ needs.metabolic_analysis.outputs.intent_type }}
**DescriÃ§Ã£o:** ${{ needs.metabolic_analysis.outputs.event_description }}

### AnÃ¡lise MetabÃ³lica
**Tipo de Impacto:** ${{ needs.metabolic_analysis.outputs.impact_type }}
**EstratÃ©gia Proposta:** ${{ needs.metabolic_analysis.outputs.mutation_strategy }}

### HistÃ³rico de Ciclos
"
          
          if [[ "${{ needs.metabolic_loop_control.outputs.limit_reached }}" == "true" ]]; then
            REPORT+="**Status:** âš ï¸ Limite de 3 ciclos metabÃ³licos atingido

**Ciclos Executados:**
1. Ciclo 1: AnÃ¡lise â†’ MutaÃ§Ã£o â†’ Vistoria (falhou)
2. Ciclo 2: AnÃ¡lise â†’ MutaÃ§Ã£o â†’ Vistoria (falhou)
3. Ciclo 3: AnÃ¡lise â†’ MutaÃ§Ã£o â†’ Vistoria (falhou)

**ConclusÃ£o:** Sistema nÃ£o conseguiu estabilizar DNA automaticamente
"
          else
            REPORT+="**Status:** âš ï¸ Escalonamento antecipado antes de mutaÃ§Ã£o

**Motivo:** ${{ needs.metabolic_analysis.outputs.escalation_reason }}
"
          fi
          
          REPORT+="

### Resultados da Vistoria
- RelatÃ³rio completo disponÃ­vel nos artefatos do workflow
- URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

### MutaÃ§Ãµes Aplicadas (Diffs)
- Ver commits na branch: \`${{ needs.metabolic_mutation.outputs.branch_name }}\`

### Riscos e LimitaÃ§Ãµes Identificadas
- Detalhes nos logs do workflow

---

**O humano (COMANDANTE) tem a palavra final.**

**PrÃ³ximas AÃ§Ãµes:**
1. Revisar anÃ¡lise metabÃ³lica e histÃ³rico de ciclos
2. Analisar mutaÃ§Ãµes aplicadas (diffs)
3. Validar resultados da vistoria
4. Decidir: aprovar, ajustar ou rejeitar mutaÃ§Ã£o

**Workflow Run:** https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
"
          
          # Criar issue para o comandante
          gh issue create \
            --title "ðŸŽ¯ COMANDANTE: IntervenÃ§Ã£o NecessÃ¡ria - ${{ needs.metabolic_analysis.outputs.event_description }}" \
            --body "$REPORT" \
            --label "commander-review" \
            --label "metabolism"
          
          echo "**âœ… RelatÃ³rio enviado ao COMANDANTE**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "$REPORT" >> $GITHUB_STEP_SUMMARY

  # ==================================================
  # 9. PRINCÃPIOS FUNDAMENTAIS - Resumo Final
  # ==================================================
  principles_summary:
    name: "ðŸ“œ PrincÃ­pios Fundamentais"
    needs: [metabolic_analysis, metabolic_mutation, homeostasis_validation]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: Resumo dos PrincÃ­pios Fundamentais
        run: |
          echo "==================================================" >> $GITHUB_STEP_SUMMARY
          echo "## 9ï¸âƒ£ PRINCÃPIOS FUNDAMENTAIS DO JARVIS" >> $GITHUB_STEP_SUMMARY
          echo "==================================================" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **O DNA Ã© sagrado** - Toda mutaÃ§Ã£o foi rastreada e auditada" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **Toda mutaÃ§Ã£o foi compreendida** - AnÃ¡lise metabÃ³lica completa" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **Testes sÃ£o o sistema imunolÃ³gico** - Vistoria executada" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **Automatizar sem perder consciÃªncia** - Escalonamento quando necessÃ¡rio" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **O humano sempre tem a palavra final** - Comandante pode intervir" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Fluxo de Metabolismo do Jarvis - Sistema MetabÃ³lico Inteligente*" >> $GITHUB_STEP_SUMMARY
