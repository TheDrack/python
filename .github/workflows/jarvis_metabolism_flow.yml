name: Jarvis Metabolism Flow

# ==================================================
# FLUXO DE METABOLISMO DO JARVIS - AUTONOMIA TOTAL
# ==================================================
#
# Regras de Engajamento:
# 1. Trigger: APENAS pull_request (qualquer branch)
# 2. O Metabolismo √© o juiz - testes validam automaticamente
# 3. Se testes passarem: Auto-Merge
# 4. Se testes falharem: Auto-Corre√ß√£o (m√°ximo 3 tentativas)
# 5. Ap√≥s 3 falhas: Marca "Manual Review Required" e notifica Comandante
#
# ==================================================

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  # ==================================================
  # VISTORIA - Testes (Sistema Imunol√≥gico)
  # ==================================================
  test_pr:
    name: "üß™ Vistoria - Executar Testes"
    runs-on: ubuntu-latest
    outputs:
      tests_passed: ${{ steps.test.outputs.tests_passed }}
      attempt_number: ${{ steps.get_attempt.outputs.attempt_number }}
      
    steps:
      - name: Checkout PR Branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          fetch-depth: 0
          token: ${{ github.token }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-json-report pytest-cov
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt || echo "Some dependencies failed, continuing..."
          fi

      - name: Get Attempt Number
        id: get_attempt
        run: |
          # Buscar n√∫mero de tentativas dos commits
          ATTEMPT=$(git log --oneline --grep="Auto-corre√ß√£o tentativa" | wc -l)
          ATTEMPT=$((ATTEMPT + 1))
          echo "attempt_number=$ATTEMPT" >> $GITHUB_OUTPUT
          echo "**Tentativa:** $ATTEMPT de 3" >> $GITHUB_STEP_SUMMARY

      - name: üß™ Executar Testes (Sistema Imunol√≥gico)
        id: test
        continue-on-error: true
        run: |
          echo "==================================================" >> $GITHUB_STEP_SUMMARY
          echo "## üß™ VISTORIA - Sistema Imunol√≥gico (Testes)" >> $GITHUB_STEP_SUMMARY
          echo "==================================================" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Executar pytest
          if pytest --json-report --json-report-file=report.json; then
            echo "tests_passed=true" >> $GITHUB_OUTPUT
            echo "**‚úÖ HOMEOSTASE MANTIDA** - Todos os testes passaram" >> $GITHUB_STEP_SUMMARY
            exit 0
          else
            echo "tests_passed=false" >> $GITHUB_OUTPUT
            echo "**‚ùå HOMEOSTASE COMPROMETIDA** - Testes falharam" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Upload Test Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-report-attempt-${{ steps.get_attempt.outputs.attempt_number }}
          path: report.json

  # ==================================================
  # AUTO-MERGE - Se testes passaram
  # ==================================================
  auto_merge:
    name: "‚úÖ Auto-Merge - Testes Aprovados"
    needs: test_pr
    if: needs.test_pr.outputs.tests_passed == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
        with:
          token: ${{ github.token }}

      - name: Enable Auto-Merge
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "==================================================" >> $GITHUB_STEP_SUMMARY
          echo "## ‚úÖ AUTO-MERGE - Testes Aprovados" >> $GITHUB_STEP_SUMMARY
          echo "==================================================" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          PR_NUMBER="${{ github.event.pull_request.number }}"
          
          echo "**Status:** Todos os testes passaram ‚úÖ" >> $GITHUB_STEP_SUMMARY
          echo "**A√ß√£o:** Habilitando auto-merge para PR #$PR_NUMBER" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Habilitar auto-merge
          gh pr merge "$PR_NUMBER" --auto --merge --repo "${{ github.repository }}" || true
          
          echo "**‚úÖ Auto-merge habilitado com sucesso**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "_O sistema confia nos testes. Nenhum revisor humano necess√°rio._" >> $GITHUB_STEP_SUMMARY

      - name: Comentar na PR
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr comment "${{ github.event.pull_request.number }}" \
            --repo "${{ github.repository }}" \
            --body "## ‚úÖ Metabolismo: Homeostase Mantida

          Todos os testes passaram com sucesso. O DNA permanece funcional.
          
          **Auto-merge habilitado.** Esta PR ser√° automaticamente mesclada assim que todos os checks forem conclu√≠dos.
          
          ---
          _Sistema de Autonomia Total - O Jarvis confia nos seus testes._"

  # ==================================================
  # AUTO-CORRE√á√ÉO - Se testes falharam (m√°x 3 tentativas)
  # ==================================================
  auto_correction:
    name: "üîß Auto-Corre√ß√£o - Tentativa ${{ needs.test_pr.outputs.attempt_number }}"
    needs: test_pr
    if: needs.test_pr.outputs.tests_passed == 'false' && needs.test_pr.outputs.attempt_number < 3
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout PR Branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          fetch-depth: 0
          token: ${{ github.token }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-json-report pytest-cov
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt || echo "Some dependencies failed, continuing..."
          fi

      - name: Download Test Report
        uses: actions/download-artifact@v4
        with:
          name: test-report-attempt-${{ needs.test_pr.outputs.attempt_number }}

      - name: Configurar Git
        run: |
          git config --global user.name "Jarvis-AutoCorrection"
          git config --global user.email "jarvis-autocorrection@bot.com"

      - name: üî¨ Analisar Erro
        id: analyze_error
        run: |
          echo "==================================================" >> $GITHUB_STEP_SUMMARY
          echo "## üîß AUTO-CORRE√á√ÉO - Tentativa ${{ needs.test_pr.outputs.attempt_number }}" >> $GITHUB_STEP_SUMMARY
          echo "==================================================" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "**Analisando falha nos testes...**" >> $GITHUB_STEP_SUMMARY
          
          # Extrair informa√ß√µes do relat√≥rio de testes
          if [ -f "report.json" ]; then
            python -c "
import json
with open('report.json', 'r') as f:
    report = json.load(f)
    failures = report.get('tests', [])
    failed = [t for t in failures if t.get('outcome') == 'failed']
    print(f'Total de testes: {len(failures)}')
    print(f'Testes com falha: {len(failed)}')
    for test in failed[:3]:  # Primeiros 3 erros
        print(f\"- {test.get('nodeid', 'unknown')}: {test.get('call', {}).get('longrepr', 'No details')}\" [:200])
" | tee -a $GITHUB_STEP_SUMMARY
          fi

      - name: üõ†Ô∏è Aplicar Corre√ß√£o Autom√°tica
        id: apply_fix
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Aplicando corre√ß√£o autom√°tica...**" >> $GITHUB_STEP_SUMMARY
          
          # Usar o metabolism_mutator para tentar corrigir
          export PYTHONPATH="${PYTHONPATH:+$PYTHONPATH:}$(pwd)"
          
          # Tentar corre√ß√£o autom√°tica baseada nos erros
          python scripts/metabolism_mutator.py \
            --strategy "fix_tests" \
            --intent "corre√ß√£o" \
            --impact "corretivo" || echo "Corre√ß√£o parcial aplicada"
          
          # Commit das corre√ß√µes
          git add .
          git commit -m "ü§ñ Auto-corre√ß√£o tentativa ${{ needs.test_pr.outputs.attempt_number }}/3

An√°lise autom√°tica de falha nos testes e aplica√ß√£o de corre√ß√µes.

Workflow: ${{ github.run_id }}" || echo "Nenhuma mudan√ßa para commitar"
          
          echo "**‚úÖ Corre√ß√£o aplicada e commitada**" >> $GITHUB_STEP_SUMMARY

      - name: Push Corre√ß√£o
        run: |
          git push origin "${{ github.event.pull_request.head.ref }}" || echo "Push failed, possibly no changes"
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**üîÑ Nova tentativa ser√° iniciada automaticamente...**" >> $GITHUB_STEP_SUMMARY

      - name: Comentar na PR
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr comment "${{ github.event.pull_request.number }}" \
            --repo "${{ github.repository }}" \
            --body "## üîß Auto-Corre√ß√£o - Tentativa ${{ needs.test_pr.outputs.attempt_number }}/3

          Os testes falharam, mas o Jarvis est√° aplicando corre√ß√µes autom√°ticas.
          
          **A√ß√£o:** Commit de corre√ß√£o aplicado. Os testes ser√£o executados novamente.
          
          ---
          _Loop de Auto-Corre√ß√£o ativo_"

  # ==================================================
  # ESCALONAMENTO - Ap√≥s 3 falhas
  # ==================================================
  escalate_to_commander:
    name: "üö® Escalonar ao Comandante"
    needs: test_pr
    if: needs.test_pr.outputs.tests_passed == 'false' && needs.test_pr.outputs.attempt_number >= 3
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
        with:
          token: ${{ github.token }}

      - name: Marcar PR como "Manual Review Required"
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "==================================================" >> $GITHUB_STEP_SUMMARY
          echo "## üö® LIMITE METAB√ìLICO ATINGIDO" >> $GITHUB_STEP_SUMMARY
          echo "==================================================" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          PR_NUMBER="${{ github.event.pull_request.number }}"
          
          echo "**Status:** 3 tentativas de auto-corre√ß√£o falharam ‚ùå" >> $GITHUB_STEP_SUMMARY
          echo "**A√ß√£o:** Marcando PR para revis√£o manual do Comandante" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Adicionar label de revis√£o manual
          gh pr edit "$PR_NUMBER" \
            --repo "${{ github.repository }}" \
            --add-label "manual-review-required" \
            --add-label "metabolism-failure"
          
          echo "**‚úÖ PR marcada para revis√£o manual**" >> $GITHUB_STEP_SUMMARY

      - name: Notificar Comandante
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Comentar na PR
          gh pr comment "${{ github.event.pull_request.number }}" \
            --repo "${{ github.repository }}" \
            --body "## üö® COMANDANTE: Interven√ß√£o Necess√°ria

          ### O que aconteceu
          Ap√≥s 3 tentativas de auto-corre√ß√£o, o sistema n√£o conseguiu fazer os testes passarem.
          
          ### Hist√≥rico de Tentativas
          1. Tentativa 1: Testes falharam ‚Üí Auto-corre√ß√£o aplicada
          2. Tentativa 2: Testes falharam ‚Üí Auto-corre√ß√£o aplicada  
          3. Tentativa 3: Testes falharam ‚Üí **LIMITE ATINGIDO**
          
          ### Pr√≥ximos Passos
          O Comandante (humano) deve:
          1. Revisar as falhas nos testes
          2. Analisar as tentativas de auto-corre√ß√£o
          3. Aplicar corre√ß√£o manual ou fechar a PR
          
          ---
          **Labels adicionadas:** \`manual-review-required\`, \`metabolism-failure\`
          
          _Sistema de Autonomia Total - Escalonamento autom√°tico ap√≥s 3 falhas_"

      - name: Criar Issue para Comandante
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh issue create \
            --repo "${{ github.repository }}" \
            --title "üö® COMANDANTE: Revis√£o Manual - PR #${{ github.event.pull_request.number }}" \
            --body "## Interven√ß√£o Necess√°ria

          **PR:** #${{ github.event.pull_request.number }} - ${{ github.event.pull_request.title }}
          **Status:** 3 tentativas de auto-corre√ß√£o falharam
          
          ### Resumo
          O fluxo de metabolismo tentou corrigir automaticamente os testes por 3 vezes, mas n√£o obteve sucesso.
          
          ### Links Importantes
          - **PR:** https://github.com/${{ github.repository }}/pull/${{ github.event.pull_request.number }}
          - **Workflow:** https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          
          ### A√ß√£o Requerida
          Revisar manualmente e decidir pr√≥ximos passos.
          
          ---
          _Criado automaticamente pelo Fluxo de Metabolismo_" \
            --label "commander-review" \
            --label "metabolism" \
            --label "high-priority"

  # ==================================================
  # RESUMO - Princ√≠pios Fundamentais
  # ==================================================
  summary:
    name: "üìú Resumo do Metabolismo"
    needs: [test_pr, auto_merge, auto_correction, escalate_to_commander]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: Resumo Final
        run: |
          echo "==================================================" >> $GITHUB_STEP_SUMMARY
          echo "## üìú PRINC√çPIOS DE AUTONOMIA TOTAL" >> $GITHUB_STEP_SUMMARY
          echo "==================================================" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ **Testes s√£o o juiz** - Sistema confia 100% nos testes" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ **Auto-merge em sucesso** - Sem revisores humanos necess√°rios" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ **Auto-corre√ß√£o inteligente** - At√© 3 tentativas de corre√ß√£o" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ **Escalonamento em falha** - Comandante notificado ap√≥s 3 tentativas" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ **Rastreabilidade completa** - Todo o processo √© documentado" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Fluxo de Metabolismo do Jarvis - Autonomia Total*" >> $GITHUB_STEP_SUMMARY
