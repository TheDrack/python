# Deployment Guide - Render Platform

This guide explains how to deploy Jarvis Assistant to Render with optimized caching and monitoring.

## Table of Contents
- [Quick Start](#quick-start)
- [Configuration](#configuration)
- [Caching Strategy](#caching-strategy)
- [Health Monitoring](#health-monitoring)
- [Troubleshooting](#troubleshooting)

## Quick Start

### Option 1: Deploy with Blueprint (Recommended)

1. **Fork/Clone this repository** to your GitHub account

2. **Connect to Render**:
   - Go to https://render.com/
   - Click "New" → "Blueprint"
   - Connect your GitHub repository
   - Select the repository containing this code

3. **Configure Environment Variables**:
   - `GEMINI_API_KEY`: Your Google Gemini API key
   - `GROQ_API_KEY`: Your Groq API key (optional)
   - `SECRET_KEY`: Auto-generated by Render (used for JWT tokens)

4. **Deploy**:
   - Render will automatically read `render.yaml`
   - Database and web service will be created
   - First deployment takes 5-10 minutes

### Option 2: Manual Deployment

1. **Create PostgreSQL Database**:
   - Go to Render Dashboard → "New" → "PostgreSQL"
   - Name: `jarvis-db`
   - Plan: Free tier is sufficient for testing

2. **Create Web Service**:
   - Go to Render Dashboard → "New" → "Web Service"
   - Connect your GitHub repository
   - Configure:
     - **Name**: `jarvis-api`
     - **Region**: Oregon (or closest to you)
     - **Branch**: `main`
     - **Build Command**: 
       ```bash
       pip install uv && uv pip install --system -r requirements/prod-cloud.txt && uv pip install --system google-generativeai groq tiktoken
       ```
     - **Start Command**: `python serve.py`
     - **Plan**: Free

3. **Configure Environment Variables**:
   - Add the environment variables as described above
   - Link `DATABASE_URL` to the PostgreSQL database

## Configuration

### Environment Variables

Required:
- `PORT`: Auto-set by Render (usually 10000)
- `DATABASE_URL`: Auto-linked from PostgreSQL service

Recommended:
- `GEMINI_API_KEY`: For AI/LLM functionality
- `GROQ_API_KEY`: Alternative LLM provider
- `SECRET_KEY`: For JWT authentication (auto-generated)

Optional:
- `LANGUAGE`: Default is `pt-BR`
- `WAKE_WORD`: Default is `jarvis`
- `USE_LLM`: Set to `true` to enable LLM features

### Database

The deployment includes a PostgreSQL database for:
- Command history
- User authentication
- Extension metadata
- Task queue

The database is automatically provisioned and connected when using the Blueprint deployment.

## Caching Strategy

### Docker Build Cache

The Dockerfile uses multi-stage builds with optimized layer caching:

1. **Dependency Layer** (cached unless requirements change):
   ```dockerfile
   COPY requirements/core.txt requirements/
   RUN uv pip install --system -r requirements/core.txt
   ```

2. **LLM Dependencies** (separate layer for flexibility):
   ```dockerfile
   RUN uv pip install --system google-generativeai groq tiktoken
   ```

3. **Application Code** (changes most frequently):
   ```dockerfile
   COPY app/ ./app/
   COPY serve.py ./serve.py
   ```

### Render Build Cache

Render automatically caches:
- Python packages installed via pip/uv
- Docker image layers
- Build artifacts

**Speed improvements**:
- First build: ~5-10 minutes
- Subsequent builds with cached dependencies: ~2-3 minutes
- Code-only changes: ~1-2 minutes

### Using uv for Faster Installs

We use `uv` (ultra-fast Python package installer) instead of pip:

```bash
pip install uv
uv pip install --system -r requirements/prod-cloud.txt
```

**Benefits**:
- 10-100x faster than pip
- Better dependency resolution
- Parallel downloads
- Smaller cache footprint

## Health Monitoring

### Health Check Endpoint

The API includes a comprehensive health check at `/health`:

```bash
curl https://your-app.onrender.com/health
```

**Response includes**:
- Overall status (healthy/degraded/unhealthy)
- API service check
- Assistant service check
- Database connectivity check
- System information (Python version, platform)
- Timestamp and version

Example response:
```json
{
  "status": "healthy",
  "timestamp": "2024-02-09T14:00:00.000Z",
  "service": "jarvis-api",
  "version": "1.0.0",
  "checks": {
    "api": {
      "status": "ok",
      "message": "API service responding"
    },
    "assistant": {
      "status": "ok",
      "message": "Assistant service available",
      "wake_word": "jarvis"
    },
    "database": {
      "status": "ok",
      "message": "Database connection available"
    }
  },
  "system": {
    "python_version": "3.11.0",
    "platform": "Linux",
    "hostname": "jarvis-api-xxxxx"
  }
}
```

### GitHub Actions Monitoring

The repository includes a health check workflow (`.github/workflows/health-check.yml`) that:

1. **Runs automatically**:
   - After every push to `main` (60 seconds after deployment)
   - Every 30 minutes via schedule
   - Manually via workflow dispatch

2. **Validates deployment**:
   - Checks HTTP status code (expects 200)
   - Validates response structure
   - Verifies critical services are operational

3. **Creates alerts**:
   - Opens GitHub issue if scheduled check fails
   - Uploads health check response as artifact
   - Provides detailed failure information

### Configuring the Monitor

1. **Set your Render URL** in GitHub Secrets:
   ```
   RENDER_HEALTH_URL=https://your-app.onrender.com/health
   ```

2. **Or update the workflow file** directly:
   ```yaml
   # In .github/workflows/health-check.yml
   echo "HEALTH_URL=https://your-app.onrender.com/health" >> $GITHUB_OUTPUT
   ```

3. **Run manual check**:
   - Go to Actions → Health Check Monitor → Run workflow

## Troubleshooting

### Build Failures

**Problem**: Dependencies fail to install
- **Solution**: Check `requirements/prod-cloud.txt` for conflicts
- **Verify**: Run locally with `uv pip install -r requirements/prod-cloud.txt`

**Problem**: Build times out
- **Solution**: Increase build timeout in Render settings
- **Check**: Remove unnecessary dependencies

### Runtime Failures

**Problem**: Service starts but health check fails
- **Check logs**: Render Dashboard → Logs
- **Verify env vars**: Ensure all required variables are set
- **Database**: Confirm DATABASE_URL is properly linked

**Problem**: Database connection errors
- **Solution**: Verify PostgreSQL service is running
- **Check**: DATABASE_URL format should be `postgresql://...`

### Health Check Issues

**Problem**: `/health` returns 503
- **Meaning**: Service is degraded or unhealthy
- **Action**: Check the response JSON for specific failed checks
- **Debug**: Look at assistant or database status in response

**Problem**: GitHub Actions health check fails
- **Check**: Ensure URL is correct in secrets or workflow
- **Verify**: Service is publicly accessible
- **Wait**: First deployment may take longer than 60 seconds

### Performance Issues

**Problem**: Slow API responses
- **Solution**: Upgrade from Free to Starter plan
- **Check**: Database query performance
- **Optimize**: Review logs for bottlenecks

**Problem**: Slow builds
- **Verify**: Cache is working (check build logs for "Using cache")
- **Solution**: Ensure requirements files haven't changed unnecessarily
- **Optimize**: Use `uv` instead of `pip` (already configured)

## Deployment Checklist

- [ ] Repository connected to Render
- [ ] `render.yaml` configured
- [ ] Environment variables set (API keys, secrets)
- [ ] PostgreSQL database created and linked
- [ ] First deployment successful
- [ ] Health check passing (`/health` returns 200)
- [ ] GitHub Actions health monitor configured
- [ ] Documentation reviewed
- [ ] Test API endpoints with authentication

## Next Steps

1. **Test the deployment**:
   ```bash
   curl https://your-app.onrender.com/health
   curl https://your-app.onrender.com/docs  # API documentation
   ```

2. **Set up monitoring**:
   - Configure GitHub Actions health check
   - Set up Render notifications
   - Monitor logs for errors

3. **Optimize**:
   - Review build times and optimize dependencies
   - Monitor resource usage
   - Consider upgrading plan if needed

4. **Secure**:
   - Rotate API keys regularly
   - Review and update SECRET_KEY
   - Enable HTTPS (automatic on Render)

## Resources

- [Render Documentation](https://render.com/docs)
- [Render Blueprint Spec](https://render.com/docs/blueprint-spec)
- [FastAPI Documentation](https://fastapi.tiangolo.com/)
- [uv Documentation](https://github.com/astral-sh/uv)

## Support

For issues or questions:
1. Check the [Troubleshooting](#troubleshooting) section
2. Review Render logs in Dashboard
3. Check GitHub Actions workflow results
4. Open an issue in the repository
